<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daily IQ & Focus Trainer</title>

  <!-- PWA Meta Tags -->
  <meta name="application-name" content="IQ Trainer">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="IQ Trainer">
  <meta name="description" content="Trainieren Sie t√§glich Ihren IQ und Ihre Konzentration">
  <meta name="theme-color" content="#00ffcc">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Content Security Policy (Basis, lokal erlaubt) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src https://fonts.gstatic.com; img-src 'self' data:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;" />
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050505;--accent:#00ffcc;--accent2:#00c3ff;--text:#f0f0f0;--muted:#888;--danger:#ff4d6a;--card-bg:rgba(255,255,255,0.05);--card-border:rgba(0,255,200,0.15);
    }
    *{box-sizing:border-box;transition:all .3s ease;}
    body{margin:0;background:radial-gradient(circle at top,#0a0a0a,#000);color:var(--text);font-family:'Poppins',sans-serif;overflow-x:hidden;}
    header{padding:3rem 1rem 1rem;text-align:center;position:relative;}
    header h1{margin:0;font-size:3rem;text-transform:uppercase;font-family:'Orbitron',sans-serif;letter-spacing:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:glow 3s ease-in-out infinite alternate;}
    @keyframes quoteReveal {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        text-shadow: 0 0 0 rgba(0,255,204,0);
      }
      50% {
        opacity: 1;
        transform: translateY(0) scale(1);
        text-shadow: 0 0 20px rgba(0,255,204,0.4);
      }
      75% {
        text-shadow: 0 0 30px rgba(0,195,255,0.6);
      }
      100% {
        text-shadow: 0 0 20px rgba(0,255,204,0.4);
      }
    }

    header .quote {
      color: var(--accent);
      font-style: italic;
      font-size: 1.2rem;
      margin-top: 1rem;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
      font-weight: 500;
      text-wrap: balance;
      position: relative;
      animation: quoteReveal 4s ease-out;
      transition: all 0.3s ease;
      padding: 1rem;
      border-radius: 8px;
    }

    header .quote:hover {
      transform: translateY(-2px) scale(1.02);
      text-shadow: 0 0 30px rgba(0,255,204,0.6);
      background: rgba(0,255,204,0.05);
      border: 1px solid rgba(0,255,204,0.1);
    }

    header .quote::before,
    header .quote::after {
      content: '"';
      position: absolute;
      font-size: 2em;
      opacity: 0.5;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent2);
    }

    header .quote::before {
      left: -5px;
      top: -10px;
    }

    header .quote::after {
      right: -5px;
      bottom: -25px;
    }
    @keyframes glow{
      0%{text-shadow:0 0 10px var(--accent);}
      50%{text-shadow:0 0 20px var(--accent),0 0 30px var(--accent2);}
      100%{text-shadow:0 0 25px var(--accent2),0 0 35px var(--accent);}
    }
    @keyframes fadeIn{
      0%{opacity:0;transform:translateY(20px);}
      100%{opacity:1;transform:translateY(0);}
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.05);}
      100%{transform:scale(1);}
    }
    @keyframes slideIn{
      0%{transform:translateX(-20px);opacity:0;}
      100%{transform:translateX(0);opacity:1;}
    }
    @keyframes cardGlow{
      0%{box-shadow:0 0 15px rgba(0,255,200,0.2);}
      50%{box-shadow:0 0 25px rgba(0,255,200,0.4);}
      100%{box-shadow:0 0 15px rgba(0,255,200,0.2);}
    }

    .lang-switch{position:absolute;top:1rem;right:1rem;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:.4rem .6rem;box-shadow:0 0 12px rgba(0,255,200,0.2);transition:all 0.3s ease;}
    .lang-switch:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,255,200,0.3);}
    .lang-switch select{background:transparent;border:none;color:var(--text);font-weight:600}

    main{max-width:1000px;margin:3rem auto;padding:2.5rem;background:rgba(15,15,15,0.85);border-radius:20px;backdrop-filter:blur(10px);box-shadow:0 0 25px rgba(0,255,200,0.3);display:grid;grid-template-columns:1fr 280px;gap:2rem;}
    @media(max-width:900px){main{grid-template-columns:1fr;}}

    h2{color:var(--accent);font-family:'Orbitron',sans-serif;margin-top:0;text-align:left;font-size:1.5rem;}

    /* Tabs / Navigation */
    .tab-buttons{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;justify-content:center;}

    /* Cards / Fragen */
    .question{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:16px;
      padding:1.4rem;
      margin:1rem 0;
      box-shadow:0 0 20px rgba(0,255,200,0.1);
      animation:fadeIn 0.5s ease-out, cardGlow 3s infinite;
      transform-origin:center;
      transition:all 0.3s ease;
    } 
    .question:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(0,255,200,0.2);
    }
    .question h3{
      margin-top:0;
      font-size:1.1rem;
      line-height:1.5;
      color:var(--text);
      animation:slideIn 0.5s ease-out;
    } 

    /* Buttons */
    button.option,button.start-btn,button.danger-btn,#consentOk{
      padding:0.7rem 1.3rem;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      background-size:200% 100%;
      color:#000;
      font-weight:600;
      min-width:140px;
      font-size:1rem;
      box-shadow:0 0 15px rgba(0,255,200,0.4);
      transition:all 0.3s ease, background-position 0.5s ease;
    } 
    button.option:hover,button.start-btn:hover,button.danger-btn:hover,#consentOk:hover{
      transform:scale(1.08) translateY(-2px);
      box-shadow:0 8px 25px rgba(0,255,200,0.6);
      background-position:right center;
    }
    button.option:active,button.start-btn:active,button.danger-btn:active,#consentOk:active{
      transform:scale(0.98);
      box-shadow:0 2px 10px rgba(0,255,200,0.3);
    } 
    button.danger-btn{background:linear-gradient(90deg,var(--danger),#ff8b4d);box-shadow:0 0 15px rgba(255,77,106,0.5);color:#000;} 
    button.small{min-width:auto;font-size:.9rem;padding:.5rem 1rem;}

    .card-center{text-align:center;padding:2rem;background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;max-width:400px;margin:0 auto 2rem;box-shadow:0 0 20px rgba(0,255,200,0.1);} 
    .start-hint{color:var(--muted);font-size:.9rem;margin-top:.8rem;}

    /* Screens */
    .screen{
      display:none;
      opacity:0;
      transform:translateY(20px);
      transition:all 0.5s ease;
    }
    .screen.active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }

    .result-line{
      font-size:1.1rem;
      color:var(--accent);
      font-weight:500;
      min-height:1.4rem;
      animation:fadeIn 0.8s ease-out;
      transition:all 0.3s ease;
    }
    .result-line:hover{
      transform:scale(1.02);
      text-shadow:0 0 10px var(--accent);
    }

    /* Sidebar */
    aside .sidebar-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:16px;
      padding:1rem;
      box-shadow:0 0 20px rgba(0,255,200,0.1);
      font-size:.9rem;
      animation:cardGlow 4s infinite;
      transition:all 0.3s ease;
    }
    aside .sidebar-card:hover{
      transform:translateY(-3px);
      box-shadow:0 10px 30px rgba(0,255,200,0.2);
    }
    .sidebar-title{
      margin-top:0;
      color:var(--accent);
      font-family:'Orbitron',sans-serif;
      font-size:0.8rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      animation:glow 3s infinite;
    }
    .sidebar-line{
      font-size:1rem;
      color:var(--text);
      transition:all 0.3s ease;
      animation:slideIn 0.5s ease-out;
    } 
    .sidebar-line:hover{
      color:var(--accent);
      transform:translateX(5px);
    }
    .sidebar-note{
      color:var(--muted);
      font-size:.8rem;
      transition:all 0.3s ease;
    }
    .ai-tip{
      margin-top:.6rem;
      color:var(--accent2);
      font-weight:600;
      animation:pulse 2s infinite;
      transition:all 0.3s ease;
    }
    .ai-tip:hover{
      transform:scale(1.02);
      color:var(--accent);
    }

    /* Statistik */
    .stats-block{background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px;padding:1rem;margin-bottom:1rem;font-size:.95rem;box-shadow:0 0 16px rgba(0,255,200,0.08);} 
    .stats-block h3{margin-top:0;font-size:1rem;color:var(--accent);font-family:'Orbitron',sans-serif;letter-spacing:.05em;}
    .history-list{list-style:none;padding-left:1rem;color:var(--text);font-size:.9rem;} 
    .history-list li{margin-bottom:.4rem;color:var(--muted);} 

    footer{text-align:center;padding:1.5rem 1rem;color:var(--muted);font-size:0.9rem;margin-top:4rem;grid-column:1 / -1;}

    /* Consent Banner */
    .consent-banner{position:fixed;left:1rem;right:1rem;bottom:1rem;background:#000;border:1px solid var(--card-border);box-shadow:0 0 20px rgba(0,255,200,0.4);border-radius:14px;padding:1rem;font-size:.8rem;color:var(--text);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;max-width:600px;margin:0 auto;z-index:9999;}
  </style>
</head>
<body>
  <header>
    <div class="lang-switch">
      <select id="langSelect" aria-label="Language">
        <option value="de" selected>üá©üá™ Deutsch</option>
        <option value="en">üá¨üáß English</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="es">üá™üá∏ Espa√±ol</option>
        <option value="tr">üáπüá∑ T√ºrk√ße</option>
      </select>
    </div>
    <p class="quote">‚ÄûDer Mensch ist der Mittelpunkt der Welt, weil er denkt.‚Äú ‚Äì Ibn Sina (Avicenna)</p>
    <h1>Daily IQ & Focus Trainer</h1>
  </header>

  <main>
    <section id="contentArea">
      <!-- Navigation Buttons -->
      <div class="tab-buttons">
        <button data-screen="intro" class="option" id="tabStart">Start</button>
        <button data-screen="iqTest" class="option" id="tabIQ">IQ‚ÄëTest</button>
        <button data-screen="psyTest" class="option" id="tabPsy">Psyche</button>
        <button data-screen="daily" class="option" id="tabDaily">üéØ Daily</button>
        <button data-screen="stats" class="option" id="tabStats">Statistik</button>
      </div>

      <!-- INTRO / START -->
      <section id="intro" class="screen active">
        <div class="card-center">
          <button id="startBtn" class="start-btn">Test starten</button>
          <p class="start-hint" id="hintLocal">Deine Ergebnisse werden nur lokal auf deinem Ger√§t gespeichert.</p>
        </div>
      </section>

      <!-- IQ TEST -->
      <section id="iqTest" class="screen">
        <h2 id="iqTitle">IQ‚ÄëTest</h2>
        <div id="iqQuestions"></div>
        <p id="iqResult" class="result-line"></p>
      </section>

      <!-- PSYCHE TEST -->
      <section id="psyTest" class="screen">
        <h2 id="psyTitle">Psyche‚ÄëAnalyse</h2>
        <div id="psyQuestions"></div>
        <p id="psyResult" class="result-line"></p>
      </section>

      <!-- DAILY CHALLENGE -->
      <section id="daily" class="screen">
        <h2>üéØ Daily Challenge</h2>
        <div id="dailyContent" class="question">
          <div id="dailyStatus" style="text-align:center; margin-bottom:1rem;"></div>
          <div id="dailyQuestion"></div>
        </div>
        <div id="dailyResult" class="result-line"></div>
        <div class="stats-block" style="margin-top:2rem;">
          <h3>üèÜ Daily Streaks</h3>
          <div id="streakInfo"></div>
        </div>
      </section>

      <!-- STATS / VERLAUF -->
      <section id="stats" class="screen">
        <h2 id="statsTitle">Deine Statistik</h2>
        
        <!-- √úbersichts-Karten -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-bottom:2rem;">
          <!-- IQ √úbersicht -->
          <div class="stats-block" style="text-align:center;">
            <h3 style="color:var(--accent)">üß† IQ Performance</h3>
            <div style="font-size:2rem; margin:1rem 0; color:var(--accent)" id="avgIQScore">--%</div>
            <div style="color:var(--muted)" id="totalIQTests">0 Tests absolviert</div>
          </div>
          
          <!-- Psyche √úbersicht -->
          <div class="stats-block" style="text-align:center;">
            <h3 style="color:var(--accent2)">üéØ Psyche Status</h3>
            <div style="font-size:2rem; margin:1rem 0; color:var(--accent2)" id="currentStressLevel">--</div>
            <div style="color:var(--muted)" id="totalPsyTests">0 Tests absolviert</div>
          </div>
        </div>

        <!-- Detaillierte Statistiken -->
        <div class="stats-block">
          <h3 style="margin-bottom:1rem;">üìä Aktuelle Leistung</h3>
          <div><strong id="labelLastIQ">Letzter IQ‚ÄëScore:</strong> <span id="statLastIQ">‚Äì</span></div>
          <div><strong id="labelLastPsy">Letzte Psyche‚ÄëEinstufung:</strong> <span id="statPsyLevel">‚Äì</span></div>
          <div style="margin-top:1rem;"><strong>Trend:</strong> <span id="performanceTrend">‚Äì</span></div>
        </div>

        <!-- Verlauf mit Zeitfilter -->
        <div class="stats-block">
          <h3 id="historyH3" style="margin-bottom:1rem;">üìÖ Verlauf</h3>
          <div class="history-filter" style="margin-bottom:1rem;">
            <button class="option small" data-filter="week">Diese Woche</button>
            <button class="option small" data-filter="month">Dieser Monat</button>
            <button class="option small" data-filter="all">Alle Zeit</button>
          </div>
          <ul id="historyList" class="history-list"></ul>
        </div>

        <div class="stats-block">
          <h3><img src="icons/icon-152x152.png" alt="logo" style="width:22px;height:22px;vertical-align:middle;border-radius:4px;margin-right:.4rem;"> üèÜ Highscore</h3>
          <div><strong>Beste IQ‚ÄëScores:</strong>
            <ol id="highscoreIQ" class="history-list"></ol>
          </div>
          <div style="margin-top:1rem"><strong>Beste Psyche‚ÄëScores:</strong>
            <ol id="highscorePsy" class="history-list"></ol>
          </div>
        </div>

        <div class="stats-block">
          <h3>üìà Fortschritt</h3>
          <div class="chart-container" style="position:relative; height:300px; width:100%; margin-top:1rem;">
            <canvas id="progressChart"></canvas>
          </div>
          <div class="chart-container" style="position:relative; height:300px; width:100%; margin-top:2rem;">
            <canvas id="stressChart"></canvas>
          </div>
        </div>

        <button id="clearDataBtn" class="danger-btn">Alle gespeicherten Daten l√∂schen</button>
        <button id="seedDemoBtn" class="start-btn small" style="margin-left:0.6rem">Demo-Daten einf√ºgen</button>
      </section>
    </section>

    <!-- SIDEBAR -->
    <aside>
      <div class="sidebar-card">
        <h4 class="sidebar-title" id="liveStatusTitle">Live Status</h4>
        <div class="sidebar-line" id="lblActive">Aktiver Test: <span id="liveTest">‚Äì</span></div>
        <div class="sidebar-line" id="lblQuestion">Frage #: <span id="liveQuestion">0</span></div>
        <div class="sidebar-line" id="lblScore">Score: <span id="liveScore">0</span></div>
        <div class="sidebar-note" id="liveNote">Bereit.</div>
        <div class="ai-tip" id="aiTip">ü§ñ KI‚ÄëTipp erscheint nach dem Test.</div>
      </div>
    </aside>

    <footer>¬© 2025 Daily IQ & Focus Trainer</footer>
  </main>

  <!-- CONSENT-BANNER (DSGVO Style) -->
  <div id="consentBanner" class="consent-banner">
    <div id="consentText">Lokale Auswertung aktiv. Deine Ergebnisse bleiben nur in deinem Browser (LocalStorage).</div>
    <button id="consentOk" class="start-btn small">OK</button>
  </div>

  <script>
    // =====================
    // Sound Effects
    // =====================
    const correctSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAUAAAnhgAGBg0NDRQUGxsbIiIiKSkpMDAwNzc3Pj4+RUVFTU1NVFRUTU1NRUVFPj4+NjY2Ly8vKCgoISEhGhoaExMTDAwMBgYGAAAAAAAA//tQxAADB3AJH4AAABBAmBk/gAAAEHN3dy93d3d3d3d3d3d3d3d3d3dwAAd3d3d3d3d3d3d3d3d3d3d3d3AHd3d3d3d3d3d3d3d3d3d3d3d3cAB3d3d3d3d3d3d3d3d3d3d3d3dwAAA=');
    const incorrectSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAUAAAnhgAGBg0NDRQUGxsbIiIiKSkpMDAwNzc3Pj4+RUVFTU1NVFRUTU1NRUVFPj4+NjY2Ly8vKCgoISEhGhoaExMTDAwMBgYGAAAAAAAA//tQxAADB3AJH4AAABBAmBk/gAAAEBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU');

    // =====================
    // i18n Texte & Fragen
    // =====================
    const i18n = {
      de: {
        ui: {
          start:'Start', iq:'IQ‚ÄëTest', psy:'Psyche', stats:'Statistik',
          introHint:'Deine Ergebnisse werden nur lokal auf deinem Ger√§t gespeichert.',
          live:{ title:'Live Status', ready:'Bereit.', activeIQ:'IQ‚ÄëTest', activePsy:'Psyche' },
          labels:{ lastIQ:'Letzter IQ‚ÄëScore:', lastPsy:'Letzte Psyche‚ÄëEinstufung:', history:'Historie' },
          results:{
            iq:(s,t)=>`Dein IQ‚ÄëScore: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=24?'Sehr entspannt': tot<=40?'Leichte Anspannung':tot<=56?'Mittleres Stresslevel':'Erh√∂htes Stresslevel'
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? 'Stark! Logik & Muster sitzen.' : s/t>=0.5 ? 'Gute Basis. Tempo & Genauigkeit weiter ausbauen.' : 'Back to basics: Kopfrechnen & Muster trainieren.',
            psy:(lvl)=> lvl.includes('Erh√∂ht') ? 'Heute 5‚ÄëMinuten‚ÄëAtmung + kurzer Walk.' : lvl.includes('Leichte') ? '45‚ÄëMinuten‚ÄëFokus, dann Mini‚ÄëBreak.' : 'Stabil ‚Äì Routinen beibehalten.'
          },
          compare:{ better:(c)=>`√úberdurchschnittlich im Vergleich zu ${c}.`, avg:(c)=>`Etwa im Durchschnitt von ${c}.`, worse:(c)=>`Unterdurchschnittlich im Vergleich zu ${c}.` }
        },
        iq: [
          {q:'Was ist 9 √ó 9?',a:['72','81','99'],c:1},
          {q:'Was ergibt 5¬≥?',a:['25','125','225'],c:1},
          {q:'Welche Zahl folgt: 2,4,8,16,?',a:['24','32','36'],c:1},
          {q:'W√§hle das Gegenteil von ‚Äûchaotisch"',a:['geordnet','hektisch','nerv√∂s'],c:0},
          {q:'Was ist 20% von 400?',a:['40','60','80'],c:2},
          {q:'Welche Zahl vervollst√§ndigt: 3,6,9,12,?',a:['13','14','15'],c:2},
          {q:'Was ist 12 √ó 12?',a:['124','144','132'],c:1},
          {q:'Wurzel aus 81?',a:['7','8','9'],c:2},
          {q:'Wie viele Sekunden hat eine Stunde?',a:['3600','6000','1800'],c:0},
          {q:'Wenn alle Rosen Blumen sind und einige Blumen schnell verbl√ºhen, was folgt?',a:['Alle Rosen verbl√ºhen schnell','Einige Rosen verbl√ºhen schnell','Keine Rosen verbl√ºhen'],c:1},
          {q:'Welches Wort passt nicht in die Reihe?',a:['Apfel','Banane','Karotte','Orange'],c:2},
          {q:'Was ist 15 √ó 15?',a:['215','225','235'],c:1},
          {q:'Welche Zahl fehlt: 1,4,9,16,?',a:['20','25','36'],c:2},
          {q:'7 √ó 8 + 3 = ?',a:['53','56','59'],c:2},
          {q:'Was ist die Wurzel aus 144?',a:['10','12','14'],c:1},
          {q:'Vervollst√§ndige die Reihe: 2,6,18,?',a:['36','54','72'],c:2},
          {q:'Ein Zug f√§hrt 250 km/h. Wie weit kommt er in 2 Stunden?',a:['400km','500km','600km'],c:1},
          {q:'Was ist das Gegenteil von "optimistisch"?',a:['realistisch','pessimistisch','skeptisch'],c:1},
          {q:'Welche Zahl ist durch 2, 3 und 4 teilbar?',a:['12','18','24'],c:2},
          {q:'Was ergibt (4 √ó 4) √ó (2 √ó 2)?',a:['48','64','96'],c:1},
          {q:'Wenn 3 √Ñpfel 2‚Ç¨ kosten, wie viel kosten 9 √Ñpfel?',a:['6‚Ç¨','9‚Ç¨','12‚Ç¨'],c:0},
          {q:'Vervollst√§ndige: A, C, F, J, ?',a:['O','N','M'],c:1},
          {q:'Was ist 1000 geteilt durch 25?',a:['25','40','75'],c:1},
          {q:'Welche Form hat vier Seiten und alle Winkel 90¬∞?',a:['Rechteck','Raute','Dreieck'],c:0},
          {q:'Vervollst√§ndige die Reihe: 5,10,20,40,?',a:['50','60','80'],c:2},
          {q:'Welche Zahl ist Prim (kleinste Zahl gr√∂√üer als 1)?',a:['2','1','0'],c:0},
          {q:'Was ist die Quadratwurzel von 169?',a:['12','13','14'],c:1}
        ],
        psy: [
          {q:'Wie oft f√ºhlst du dich unter Druck?',a:['Nie','Selten','Manchmal','Oft','Sehr oft'],s:[1,2,3,4,5]},
          {q:'Kannst du gut abschalten?',a:['Ja','Meistens','Teilweise','Selten','Nein'],s:[1,2,3,4,5]},
          {q:'Wie stabil f√ºhlst du dich in Konflikten?',a:['Sehr stabil','Stabil','Unsicher','Instabil','Sehr instabil'],s:[1,2,3,4,5]},
          {q:'Wie erholt f√ºhlst du dich morgens?',a:['Sehr','Gut','Geht so','M√ºde','Ersch√∂pft'],s:[1,2,3,4,5]},
          {q:'Wie h√§ufig gr√ºbelst du?',a:['Nie','Selten','Manchmal','Oft','St√§ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut gelingt dir Fokus ohne Ablenkung?',a:['Sehr gut','Gut','Okay','Schwer','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie ausgeglichen ist deine Stimmung?',a:['Sehr','Ziemlich','Teils','Eher nicht','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie ist dein Stress aktuell?',a:['Sehr niedrig','Niedrig','Mittel','Hoch','Sehr hoch'],s:[1,2,3,4,5]},
          {q:'Wie gut schl√§fst du nachts?',a:['Sehr gut','Gut','Mittelm√§√üig','Schlecht','Sehr schlecht'],s:[1,2,3,4,5]},
          {q:'Wie oft hast du Kopfschmerzen?',a:['Nie','Selten','Gelegentlich','H√§ufig','Sehr h√§ufig'],s:[1,2,3,4,5]},
          {q:'Wie zufrieden bist du mit deiner Work-Life-Balance?',a:['Sehr','Ziemlich','Mittel','Wenig','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie oft f√ºhlst du dich √ºberfordert?',a:['Nie','Selten','Manchmal','Oft','St√§ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut kannst du "Nein" sagen?',a:['Sehr gut','Gut','Mittel','Schwer','Sehr schwer'],s:[1,2,3,4,5]},
          {q:'Wie oft nimmst du dir Zeit f√ºr dich selbst?',a:['T√§glich','Oft','Manchmal','Selten','Nie'],s:[1,2,3,4,5]},
          {q:'Wie h√§ufig f√ºhlst du dich energielos?',a:['Nie','Selten','Manchmal','Oft','St√§ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut kannst du Priorit√§ten setzen?',a:['Sehr gut','Gut','Mittel','Schwer','Sehr schwer'],s:[1,2,3,4,5]},
          {q:'Wie schnell erholst du dich von Stress?',a:['Sofort','Schnell','M√§√üig','Langsam','Sehr langsam'],s:[1,2,3,4,5]},
          {q:'Wie oft nimmst du Pausen w√§hrend der Arbeit?',a:['Regelm√§√üig','Oft','Manchmal','Selten','Nie'],s:[1,2,3,4,5]},
          {q:'Wie gut planst du deinen Tag im Voraus?',a:['Sehr gut','Gut','Okay','Schwach','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie sehr beeinflusst Schlaf deine Leistungsf√§higkeit?',a:['Gar nicht','Wenig','Mittel','Stark','Sehr stark'],s:[1,2,3,4,5]},
          {q:'Wie oft f√ºhlst du dich energiegeladen?',a:['T√§glich','Mehrmals/Woche','Manchmal','Selten','Nie'],s:[1,2,3,4,5]}
        ]
      },
      en: {
        ui: {
          start:'Start', iq:'IQ Test', psy:'Psyche', stats:'Stats',
          introHint:'Your results are stored locally in your browser only.',
          live:{ title:'Live Status', ready:'Ready.', activeIQ:'IQ Test', activePsy:'Psyche' },
          labels:{ lastIQ:'Last IQ Score:', lastPsy:'Last Psyche Level:', history:'History' },
          results:{
            iq:(s,t)=>`Your IQ score: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=12?'Very relaxed': tot<=20?'Mild tension':'Elevated stress'
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? 'Great! Strong logic & patterns.' : s/t>=0.5 ? 'Solid base. Improve speed & accuracy.' : 'Back to fundamentals: mental math & patterns.',
            psy:(lvl)=> lvl.includes('Elevated') ? 'Try 5‚Äëminute breathing + short walk.' : lvl.includes('Mild') ? '45‚Äëmin focus, then a micro‚Äëbreak.' : 'Stable ‚Äì keep routines.'
          },
          compare:{ better:(c)=>`Above average vs ${c}.`, avg:(c)=>`Around the average of ${c}.`, worse:(c)=>`Below average vs ${c}.` }
        },
        iq: [
          {q:'What is 9 √ó 9?',a:['72','81','99'],c:1},
          {q:'What is 5¬≥?',a:['25','125','225'],c:1},
          {q:'Which number comes next: 2,4,8,16,?',a:['24','32','36'],c:1},
          {q:'Choose the opposite of ‚Äúchaotic‚Äù',a:['orderly','hectic','nervous'],c:0},
          {q:'What is 20% of 400?',a:['40','60','80'],c:2},
          {q:'Complete: 3,6,9,12,?',a:['13','14','15'],c:2},
          {q:'What is 12 √ó 12?',a:['124','144','132'],c:1},
          {q:'Square root of 81?',a:['7','8','9'],c:2},
          {q:'How many seconds in an hour?',a:['3600','6000','1800'],c:0},
          {q:'If all roses are flowers and some flowers wither quickly, what follows?',a:['All roses wither quickly','Some roses wither quickly','No roses wither'],c:1},
          {q:'If 4 pens cost $3, how much for 12 pens?',a:['$6','$9','$12'],c:1},
          {q:'Which word does not belong: apple, banana, carrot, orange?',a:['carrot','banana','orange'],c:0},
          {q:'What is 15 √ó 15?',a:['215','225','235'],c:1},
          {q:'Complete the sequence: 1,4,9,16,?',a:['20','25','36'],c:1},
          {q:'7 √ó 8 + 3 = ?',a:['53','56','59'],c:2},
          {q:'What is the square root of 169?',a:['12','13','14'],c:1},
          {q:'Which shape has four equal sides and opposite angles equal?',a:['Square','Rectangle','Parallelogram'],c:0}
        ],
        psy: [
          {q:'How often do you feel under pressure?',a:['Never','Rarely','Sometimes','Often','Very often'],s:[1,2,3,4,5]},
          {q:'Can you switch off well?',a:['Yes','Mostly','Partly','Rarely','No'],s:[1,2,3,4,5]},
          {q:'How stable are you in conflicts?',a:['Very stable','Stable','Insecure','Unstable','Very unstable'],s:[1,2,3,4,5]},
          {q:'How refreshed do you feel in the morning?',a:['Very','Good','So‚Äëso','Tired','Exhausted'],s:[1,2,3,4,5]},
          {q:'How often do you ruminate?',a:['Never','Rarely','Sometimes','Often','Constantly'],s:[1,2,3,4,5]},
          {q:'How well can you focus without distraction?',a:['Very well','Well','Okay','Hard','Not at all'],s:[1,2,3,4,5]},
          {q:'How balanced is your mood?',a:['Very','Quite','Partly','Rather not','Not at all'],s:[1,2,3,4,5]},
          {q:'What is your current stress level?',a:['Very low','Low','Medium','High','Very high'],s:[1,2,3,4,5]},
          {q:'How well do you manage interruptions?',a:['Very well','Well','Okay','Poor','Very poor'],s:[1,2,3,4,5]},
          {q:'How regular is your sleep schedule?',a:['Very regular','Mostly','Sometimes','Rarely','Never'],s:[1,2,3,4,5]},
          {q:'How often do you exercise per week?',a:['Daily','Several times','Once','Rarely','Never'],s:[1,2,3,4,5]},
          {q:'How motivated do you feel for daily tasks?',a:['Very motivated','Motivated','Neutral','Less motivated','Unmotivated'],s:[1,2,3,4,5]}
        ]
      }
    };

    // Language flag mapping for leaderboard and UI
    const langFlags = { de: 'üá©üá™', en: 'üá¨üáß', fr: 'üá´üá∑', es: 'üá™üá∏', tr: 'üáπüá∑' };

    // =====================
    // Sprache speichern/laden
    // =====================
    const langSelect = document.getElementById('langSelect');
    const getLang = () => localStorage.getItem('lang') || 'de';
    const setLang = (l)=>{ localStorage.setItem('lang', l); langSelect.value = l; applyLang(); };

    // Helpers to safely get localized content (fallback to 'en')
    function getLocale(key) {
      return (i18n[getLang()] && i18n[getLang()].ui && i18n[getLang()].ui[key]) ? i18n[getLang()].ui[key] : i18n['en'].ui[key];
    }
    function getIQ(){ return (i18n[getLang()] && i18n[getLang()].iq) ? i18n[getLang()].iq : i18n['en'].iq; }
    function getPsy(){ return (i18n[getLang()] && i18n[getLang()].psy) ? i18n[getLang()].psy : i18n['en'].psy; }

    // =====================
    // Screen Handling / Navigation
    // =====================
    const screens = document.querySelectorAll('.screen');
    const navButtons = document.querySelectorAll('.tab-buttons button');
    const liveTestEl = document.getElementById('liveTest');
    const liveQuestionEl = document.getElementById('liveQuestion');
    const liveScoreEl = document.getElementById('liveScore');
    const liveNoteEl = document.getElementById('liveNote');

    function showScreen(id){
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      liveTestEl.textContent = id === 'iqTest' ? (getLang()==='de'? i18n.de.ui.live.activeIQ : i18n.en.ui.live.activeIQ)
        : id === 'psyTest' ? (getLang()==='de'? i18n.de.ui.live.activePsy : i18n.en.ui.live.activePsy)
        : '‚Äì';
      liveNoteEl.textContent = id === 'psyTest' ? (getLang()==='de'?'Ehrlich antworten.':'Answer honestly.') : (getLang()==='de'? i18n.de.ui.live.ready : i18n.en.ui.live.ready);
      if(id === 'stats') updateStatsDisplay();
    }

    navButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target = btn.getAttribute('data-screen');
        showScreen(target);
      });
    });

    // =====================
    // Consent Banner
    // =====================
    const consentBanner = document.getElementById('consentBanner');
    const consentOk = document.getElementById('consentOk');
    if(localStorage.getItem('consentAccepted') === '1') consentBanner.style.display = 'none';
    consentOk.addEventListener('click',()=>{ localStorage.setItem('consentAccepted','1'); consentBanner.style.display = 'none'; });

    // =====================
    // IQ‚ÄëTest Logik + KI‚ÄëFeedback + L√§nder-Vergleich
    // =====================
    const iqContainer = document.getElementById('iqQuestions');
    const iqResult = document.getElementById('iqResult');
    const aiTip = document.getElementById('aiTip');

  let iqIndex = 0; let iqScore = 0;
  // track user's chosen answers for breakdown
  let iqUserAnswers = [];

  // (use safer getIQ above)

    function renderIQ() {
      const arr = getIQ();
      if(iqIndex >= arr.length) {
        const msg = i18n[getLang()].ui.results.iq(iqScore, arr.length);
        iqResult.textContent = msg;

        // KI‚ÄëFeedback (lokal, regelbasiert)
        const tip = i18n[getLang()].ui.ai.iq(iqScore, arr.length);
        aiTip.textContent = 'ü§ñ ' + tip;

        // Weltweite Einordnung (Percentile) + L√§ndervergleich (Deutschland ‚âà 102)
        const percentile = Math.round((iqScore / arr.length) * 100);
        let globalRank = '‚Äî';
        if(percentile >= 90) globalRank = getLang()==='de' ? 'Top 10% weltweit' : 'Top 10% worldwide';
        else if(percentile >= 70) globalRank = getLang()==='de' ? 'Top 30% weltweit' : 'Top 30% worldwide';
        else if(percentile >= 50) globalRank = getLang()==='de' ? 'Durchschnittsbereich weltweit' : 'Average range worldwide';
        else if(percentile >= 30) globalRank = getLang()==='de' ? 'Unterdurchschnittlich (global)' : 'Below average (global)';
        else globalRank = getLang()==='de' ? 'Deutlich unter Durchschnitt (global)' : 'Significantly below average (global)';

        const country = getLang()==='de' ? 'Deutschland (√ò 102)' : 'World avg (100)';
        const estIQ = Math.round((iqScore / arr.length) * 150); // grobe Normierung auf 150 Max
        let compareTxt;
        if(getLang()==='de'){
          compareTxt = estIQ > 107 ? i18n.de.ui.compare.better(country) : estIQ < 97 ? i18n.de.ui.compare.worse(country) : i18n.de.ui.compare.avg(country);
        } else {
          compareTxt = estIQ > 105 ? i18n.en.ui.compare.better(country) : estIQ < 95 ? i18n.en.ui.compare.worse(country) : i18n.en.ui.compare.avg(country);
        }

        const globalInfo = document.createElement('div');
        globalInfo.style.color = 'var(--accent2)';
        globalInfo.style.marginTop = '0.6rem';
        globalInfo.style.fontWeight = '600';
        globalInfo.style.textAlign = 'center';
        globalInfo.innerHTML = `üåç <strong>${getLang()==='de' ? 'Weltweite Einstufung' : 'Global Ranking'}:</strong> ${globalRank}<br>üß† ${compareTxt}`;
        iqResult.insertAdjacentElement('afterend', globalInfo);

        // build details array showing each question, chosen answer and correctness
        const details = arr.map((q, idx) => ({
          q: q.q,
          choices: q.a,
          chosenIndex: typeof iqUserAnswers[idx] === 'number' ? iqUserAnswers[idx] : null,
          correctIndex: q.c,
          correct: typeof iqUserAnswers[idx] === 'number' ? (iqUserAnswers[idx] === q.c) : false
        }));

        saveResult({ type:'iq', score: iqScore, total: arr.length, ts: Date.now(), lang:getLang(), details });
        // also render a detailed breakdown below the result
        const breakdown = document.createElement('div');
        breakdown.style.marginTop = '1rem';
        breakdown.innerHTML = '<h4 style="color:var(--accent);margin-bottom:.4rem">Detailierte Auswertung</h4>' +
          details.map((d,i)=>{
            const chosen = d.chosenIndex!==null ? d.choices[d.chosenIndex] : '‚Äî';
            const correct = d.choices[d.correctIndex];
            const ok = d.correct ? '‚úÖ' : '‚ùå';
            return `<div style="text-align:left;padding:.4rem;border-radius:8px;margin-bottom:.25rem;background:rgba(255,255,255,0.02)"><strong>Frage ${i+1}:</strong> ${d.q}<br><em>Deine Antwort:</em> ${chosen} ${ok} <br><em>Richtig:</em> ${correct}</div>`;
          }).join('');
        iqResult.insertAdjacentElement('afterend', breakdown);
        // reset user answers for next run
        iqUserAnswers = [];
        updateStatsDisplay();
        return;
      }

      const q = arr[iqIndex];
      liveQuestionEl.textContent = iqIndex+1; liveScoreEl.textContent = iqScore;
      iqContainer.innerHTML = `
        <div class="question">
          <h3>${q.q}</h3>
          ${q.a.map((opt,i)=>`<button class="option" data-i="${i}">${opt}</button>`).join('')}
        </div>
      `;

      iqContainer.querySelectorAll('button.option').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const chosen = Number(btn.getAttribute('data-i'));
          // store chosen answer for this question
          iqUserAnswers[iqIndex] = chosen;
          if(chosen === q.c) {
            iqScore++;
            correctSound.play().catch(e => console.log('Sound play failed:', e));
            btn.style.background = 'linear-gradient(90deg,#00ff00,#00cc00)';
          } else {
            incorrectSound.play().catch(e => console.log('Sound play failed:', e));
            btn.style.background = 'linear-gradient(90deg,#ff0000,#cc0000)';
          }
          
          // Disable all buttons after answer
          btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
          
          // Show correct answer if wrong
          if(chosen !== q.c) {
            btn.parentElement.querySelectorAll('button')[q.c].style.background = 'linear-gradient(90deg,#00ff00,#00cc00)';
          }
          
          // Wait a moment to show the result
          setTimeout(() => {
            iqIndex++;
            renderIQ();
          }, 1000);
        });
      });
    }

    // =====================
    // Psyche‚ÄëAnalyse Logik (5‚ÄëStufen) + KI‚ÄëTipp
    // =====================
    const psyContainer = document.getElementById('psyQuestions');
    const psyResult = document.getElementById('psyResult');
    let psyAnswers = [];

  // (use safer getPsy above)

    function renderPsy(){
      psyContainer.innerHTML = '';
      psyAnswers = [];
      const arr = getPsy();

      arr.forEach((item, idx) => {
        const block = document.createElement('div');
        block.classList.add('question');
        block.innerHTML = `
          <h3>${item.q}</h3>
          ${item.a.map((ans,i)=>`<button class="option" data-question="${idx}" data-score="${item.s[i]}">${ans}</button>`).join('')}
        `;
        psyContainer.appendChild(block);
      });

      psyContainer.querySelectorAll('button.option').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const qIndex = Number(btn.getAttribute('data-question'));
          const score  = Number(btn.getAttribute('data-score'));
            // store chosen index and score for details
            const chosenIndex = Array.from(btn.parentElement.querySelectorAll('button.option')).indexOf(btn);
            if(!psyAnswers[qIndex]) psyAnswers[qIndex] = {};
            psyAnswers[qIndex] = { chosenIndex, score, label: btn.textContent };

          if(psyAnswers.filter(v=>v!==undefined).length === getPsy().length){
              const total = psyAnswers.reduce((a,b)=>a + (b.score||0),0);
              const lvl = i18n[getLang()].ui.results.psycheLevel(total);
              psyResult.textContent = lvl;
              const tip = i18n[getLang()].ui.ai.psy(lvl);
              aiTip.textContent = 'ü§ñ ' + tip;
              // build details for psyche
              const psyDetails = getPsy().map((item, idx) => ({ q: item.q, chosen: psyAnswers[idx] ? psyAnswers[idx].label : null, score: psyAnswers[idx] ? psyAnswers[idx].score : null }));
              saveResult({ type:'psy', level: lvl, score: total, ts: Date.now(), lang:getLang(), details: psyDetails });
              updateStatsDisplay();
          }
        });
      });
    }

    // =====================
    // LocalStorage Persistenz & Statistik
    // =====================
    const statLastIQ = document.getElementById('statLastIQ');
    const statPsyLevel = document.getElementById('statPsyLevel');
    const historyList = document.getElementById('historyList');
    const clearDataBtn = document.getElementById('clearDataBtn');

    function saveResult(entry){
      const raw = localStorage.getItem('history');
      const hist = raw ? JSON.parse(raw) : [];
      hist.push(entry);
      if(hist.length > 200) hist.shift();
      localStorage.setItem('history', JSON.stringify(hist));
      // Update stats immediately after saving so leaderboard refreshes
      try{ updateStatsDisplay(); }catch(e){ /* ignore if UI not ready yet */ }
    }

    // Chart Instances
    let progressChart = null;
    let stressChart = null;

    function updateStatsDisplay(){
      const raw = localStorage.getItem('history');
      const hist = raw ? JSON.parse(raw) : [];
      
      // Update Charts
      updateCharts(hist);
      
      // Berechne durchschnittliche IQ-Performance
      const iqTests = hist.filter(e => e.type === 'iq');
      const avgScore = iqTests.length > 0 
        ? Math.round(iqTests.reduce((acc, curr) => acc + (curr.score / curr.total * 100), 0) / iqTests.length) 
        : 0;
      document.getElementById('avgIQScore').textContent = avgScore + '%';
      document.getElementById('totalIQTests').textContent = `${iqTests.length} Tests absolviert`;
      
      // Berechne aktuelles Stress-Level
      const psyTests = hist.filter(e => e.type === 'psy');
      const latestPsy = psyTests[psyTests.length - 1];
      document.getElementById('currentStressLevel').textContent = latestPsy ? latestPsy.level : '--';
      document.getElementById('totalPsyTests').textContent = `${psyTests.length} Tests absolviert`;
      
      // Berechne Performance-Trend
      if (iqTests.length >= 2) {
        const recent = iqTests.slice(-3); // Letzte 3 Tests
        const trend = recent.reduce((acc, curr, i, arr) => {
          if (i === 0) return 0;
          return acc + (curr.score/curr.total - arr[i-1].score/arr[i-1].total);
        }, 0);
        
        const trendEl = document.getElementById('performanceTrend');
        if (trend > 0) {
          trendEl.textContent = 'üìà Verbesserung';
          trendEl.style.color = '#00ff00';
        } else if (trend < 0) {
          trendEl.textContent = 'üìâ Leichter R√ºckgang';
          trendEl.style.color = 'var(--danger)';
        } else {
          trendEl.textContent = '‚û°Ô∏è Stabil';
          trendEl.style.color = 'var(--accent)';
        }
      }

      const lastIQ = [...hist].reverse().find(e=>e.type==='iq');
      statLastIQ.textContent = lastIQ ? `${lastIQ.score} / ${lastIQ.total}` : '‚Äì';

      const lastPsy = [...hist].reverse().find(e=>e.type==='psy');
      statPsyLevel.textContent = lastPsy ? lastPsy.level : '‚Äì';

      // Filter-Handler f√ºr Verlauf
      const filterButtons = document.querySelectorAll('.history-filter button');
      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.getAttribute('data-filter');
          updateHistory(hist, filter);
          
          // Update Button-Styles
          filterButtons.forEach(b => {
            b.style.background = b === btn ? 
              'linear-gradient(90deg,var(--accent),var(--accent2))' : 
              'linear-gradient(90deg,var(--accent2),var(--accent))';
          });
        });
      });
      
      updateHistory(hist, 'week'); // Standard: Diese Woche anzeigen
    }
    
    function updateHistory(hist, filter) {
      const now = new Date();
      const filtered = hist.filter(entry => {
        const entryDate = new Date(entry.ts);
        if (filter === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return entryDate >= weekAgo;
        } else if (filter === 'month') {
          const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          return entryDate >= monthAgo;
        }
        return true; // 'all' Filter
      });
      
      historyList.innerHTML = '';
      if (filtered.length === 0) {
        historyList.innerHTML = '<li style="text-align:center;color:var(--muted)">Keine Eintr√§ge im gew√§hlten Zeitraum</li>';
        return;
      }
      
      filtered.slice().reverse().forEach(entry=>{
        let line='';
        if(entry.type==='iq') line = `IQ: ${entry.score}/${entry.total}`;
        else if(entry.type==='psy') line = `Psyche: ${entry.level} (Score ${entry.score})`;
        const li = document.createElement('li');
        const date = new Date(entry.ts).toLocaleString();
        // main text
        const mainSpan = document.createElement('span');
        mainSpan.textContent = `${date} ‚Äì ${line}`;
        li.appendChild(mainSpan);

        // details toggle if available
        if(entry.details && Array.isArray(entry.details) && entry.details.length){
          const detailsBtn = document.createElement('button');
          detailsBtn.className = 'small';
          detailsBtn.style.marginLeft = '0.6rem';
          detailsBtn.textContent = 'Details';
          const detailsDiv = document.createElement('div');
          detailsDiv.style.display = 'none';
          detailsDiv.style.marginTop = '0.5rem';
          detailsDiv.style.textAlign = 'left';
          // build html for details depending on type
          if(entry.type === 'iq'){
            detailsDiv.innerHTML = entry.details.map((d,i)=>{
              const chosen = (d.chosenIndex!==null && d.choices[d.chosenIndex]) ? d.choices[d.chosenIndex] : '‚Äî';
              const correct = d.choices[d.correctIndex];
              const ok = d.correct ? '‚úÖ' : '‚ùå';
              return `<div style="padding:.3rem;border-radius:6px;margin-bottom:.2rem;background:rgba(255,255,255,0.02)"><strong>Q${i+1}:</strong> ${d.q}<br><em>Deine:</em> ${chosen} ${ok} <em>Richtig:</em> ${correct}</div>`;
            }).join('');
          } else if(entry.type === 'psy'){
            detailsDiv.innerHTML = entry.details.map((d,i)=>{
              return `<div style="padding:.3rem;border-radius:6px;margin-bottom:.2rem;background:rgba(255,255,255,0.02)"><strong>Q${i+1}:</strong> ${d.q}<br><em>Antwort:</em> ${d.chosen} <em>(Score ${d.score})</em></div>`;
            }).join('');
          }

          detailsBtn.addEventListener('click', ()=>{
            detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
            detailsBtn.textContent = detailsDiv.style.display === 'none' ? 'Details' : 'Schlie√üen';
          });
          li.appendChild(detailsBtn);
          li.appendChild(detailsDiv);
        }

        historyList.appendChild(li);
      });

      // Highscore IQ
      const highscoreIQ = document.getElementById('highscoreIQ');
      if (highscoreIQ) {
        highscoreIQ.innerHTML = '';
  const iqScores = hist.filter(e=>e.type==='iq').map(e=>({score:e.score,total:e.total,date:e.ts, lang: e.lang || 'de'}));
  // Sort by score desc, then by most recent date
  iqScores.sort((a,b)=> (b.score - a.score) || (b.date - a.date));
        iqScores.slice(0,5).forEach(e=>{
          const li = document.createElement('li');
          const flag = langFlags[e.lang] || 'üè≥Ô∏è';
          li.innerHTML = `<img src="icons/icon-152x152.png" style="width:18px;height:18px;border-radius:4px;vertical-align:middle;margin-right:.4rem"> <span style="margin-right:.4rem">${flag}</span> <strong>${e.score} / ${e.total}</strong> <span style="color:var(--muted); margin-left:.6rem">(${new Date(e.date).toLocaleDateString()})</span>`;
          highscoreIQ.appendChild(li);
        });
        if(iqScores.length===0){
          const li = document.createElement('li');
          li.textContent = '‚Äì';
          highscoreIQ.appendChild(li);
        }
      }

      // Highscore Psyche
      const highscorePsy = document.getElementById('highscorePsy');
      if (highscorePsy) {
        highscorePsy.innerHTML = '';
  const psyScores = hist.filter(e=>e.type==='psy').map(e=>({score:e.score,level:e.level,date:e.ts, lang: e.lang || 'de'}));
  // For psyche, lower score means better (more relaxed) ‚Äî show best (lowest) first, tiebreak by most recent
  psyScores.sort((a,b)=> (a.score - b.score) || (b.date - a.date));
        psyScores.slice(0,5).forEach(e=>{
          const li = document.createElement('li');
          const flag = langFlags[e.lang] || 'üè≥Ô∏è';
          li.innerHTML = `<img src="icons/icon-152x152.png" style="width:18px;height:18px;border-radius:4px;vertical-align:middle;margin-right:.4rem"> <span style="margin-right:.4rem">${flag}</span> <strong>${e.level}</strong> <span style="color:var(--muted); margin-left:.6rem">(${e.score})</span> <span style="color:var(--muted); margin-left:.6rem">(${new Date(e.date).toLocaleDateString()})</span>`;
          highscorePsy.appendChild(li);
        });
        if(psyScores.length===0){
          const li = document.createElement('li');
          li.textContent = '‚Äì';
          highscorePsy.appendChild(li);
        }
      }
    }

    function updateCharts(hist) {
      const ctx1 = document.getElementById('progressChart');
      const ctx2 = document.getElementById('stressChart');

      // Process data for IQ progress
      const iqData = hist.filter(e => e.type === 'iq').map(e => ({
        score: (e.score / e.total) * 100,
        date: new Date(e.ts)
      }));

      // Process data for Stress levels
      const stressData = hist.filter(e => e.type === 'psy').map(e => ({
        score: e.score,
        date: new Date(e.ts)
      }));

      // Destroy existing charts
      if (progressChart) progressChart.destroy();
      if (stressChart) stressChart.destroy();

      // Create IQ Progress Chart
      progressChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: iqData.map(d => d.date.toLocaleDateString()),
          datasets: [{
            label: 'IQ Score (%)',
            data: iqData.map(d => d.score),
            borderColor: '#00ffcc',
            backgroundColor: 'rgba(0, 255, 204, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: { color: '#f0f0f0' }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: { color: '#f0f0f0' }
            }
          },
          plugins: {
            legend: {
              labels: { color: '#f0f0f0' }
            }
          }
        }
      });

      // Create Stress Level Chart
      stressChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: stressData.map(d => d.date.toLocaleDateString()),
          datasets: [{
            label: 'Stress Level',
            data: stressData.map(d => d.score),
            borderColor: '#00c3ff',
            backgroundColor: 'rgba(0, 195, 255, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: { color: '#f0f0f0' }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: { color: '#f0f0f0' }
            }
          },
          plugins: {
            legend: {
              labels: { color: '#f0f0f0' }
            }
          }
        }
      });
    }

    clearDataBtn.addEventListener('click',()=>{
      localStorage.removeItem('history');
      updateStatsDisplay();
    });

    // Demo / Seed data for testing the leaderboard
    const seedDemoBtn = document.getElementById('seedDemoBtn');
    if(seedDemoBtn){
      seedDemoBtn.addEventListener('click', ()=>{
        const sample = [
          {type:'iq', score:18, total:20, ts: Date.now()-86400000*2, lang:'de'},
          {type:'iq', score:15, total:20, ts: Date.now()-86400000*5, lang:'de'},
          {type:'iq', score:20, total:20, ts: Date.now()-86400000*1, lang:'de'},
          {type:'psy', level:'Sehr entspannt', score:16, ts: Date.now()-86400000*3, lang:'de'},
          {type:'psy', level:'Leichte Anspannung', score:30, ts: Date.now()-86400000*6, lang:'de'},
          {type:'psy', level:'Sehr entspannt', score:18, ts: Date.now()-86400000*1, lang:'de'}
        ];
        localStorage.setItem('history', JSON.stringify(sample));
        updateStatsDisplay();
      });
    }

    // =====================
    // Category Selection
    // =====================
    document.querySelectorAll('.category-select button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentCategory = btn.getAttribute('data-category');
        iqIndex = 0;
        iqScore = 0;
        iqUserAnswers = [];
        renderIQ(currentCategory);
        
        // Highlight selected category
        document.querySelectorAll('.category-select button').forEach(b => {
          b.style.background = b === btn ? 
            'linear-gradient(90deg,var(--accent),var(--accent2))' : 
            'linear-gradient(90deg,var(--accent2),var(--accent))';
        });
      });
    });

    // =====================
    // Start Button Verhalten
    // =====================
    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click',()=>{
      showScreen('iqTest');
      iqIndex = 0; iqScore = 0; renderIQ();
      startBtn.disabled = true;
      startBtn.textContent = getLang()==='de' ? 'L√§uft...' : 'Running...';
    });

    // =====================
    // Sprache anwenden (sichere Fallbacks)
    // =====================
    function applyLang(){
      // Use the selected language UI object if available, otherwise fall back to English
      const L = (i18n[getLang()] && i18n[getLang()].ui) ? i18n[getLang()].ui : i18n['en'].ui;
      document.getElementById('tabStart').textContent = L.start;
      document.getElementById('tabIQ').textContent = L.iq;
      document.getElementById('tabPsy').textContent = L.psy;
      document.getElementById('tabStats').textContent = L.stats;
      document.getElementById('hintLocal').textContent = L.introHint;
      // Some nested properties may not exist in all translations; guard access
      document.getElementById('liveStatusTitle').textContent = (L.live && L.live.title) ? L.live.title : i18n['en'].ui.live.title;
      document.getElementById('iqTitle').textContent = L.iq;
      document.getElementById('psyTitle').textContent = L.psy;
      document.getElementById('statsTitle').textContent = L.stats;
      document.getElementById('labelLastIQ').textContent = (L.labels && L.labels.lastIQ) ? L.labels.lastIQ : i18n['en'].ui.labels.lastIQ;
      document.getElementById('labelLastPsy').textContent = (L.labels && L.labels.lastPsy) ? L.labels.lastPsy : i18n['en'].ui.labels.lastPsy;
      document.getElementById('historyH3').textContent = (L.labels && L.labels.history) ? L.labels.history : i18n['en'].ui.labels.history;
      // Re-render any language-dependent screens
      try{ renderPsy(); } catch(e){ console.warn('renderPsy() failed during language apply:', e); }
    }

    langSelect.addEventListener('change', ()=> setLang(langSelect.value));

    // Automatische Statistik-Aktualisierung
    function startStatsAutoUpdate() {
      // Initial update
      updateStatsDisplay();
      
      // Update alle 30 Sekunden, wenn Statistik-Tab aktiv ist
      setInterval(() => {
        if (document.getElementById('stats').classList.contains('active')) {
          updateStatsDisplay();
        }
      }, 30000);
    }

    // Initialisieren
    setLang(getLang());
    renderPsy();
    // Start auto-updating stats
    try{ 
      startStatsAutoUpdate();
    } catch(e){ 
      console.log('Fehler beim Initialisieren der Statistik:', e);
    }

    // --- Anpassbares Zitat (lokal editierbar) ---
    (function(){
      const quoteEl = document.querySelector('.quote');
      if(!quoteEl) return;
      // Lade gespeichertes Zitat (falls vorhanden)
      const saved = localStorage.getItem('customQuote');
      if(saved) quoteEl.textContent = saved;

      // Erstelle Bearbeiten-Button
      const editBtn = document.createElement('button');
      editBtn.className = 'small';
      editBtn.style.marginLeft = '0.6rem';
      editBtn.style.background = 'linear-gradient(90deg,var(--accent2),var(--accent))';
      editBtn.textContent = 'Zitat bearbeiten';
      editBtn.title = 'Zitat anpassen (nur lokal)';
      editBtn.addEventListener('click', ()=>{
        const current = quoteEl.textContent || '';
        const v = prompt('Neues Zitat eingeben (Autor optional):', current);
        if(v !== null){
          quoteEl.textContent = v;
          localStorage.setItem('customQuote', v);
          // kleine Animation zur√ºcksetzen
          quoteEl.style.animation = 'none';
          void quoteEl.offsetWidth;
          quoteEl.style.animation = 'quoteReveal 2s ease-out';
        }
      });

      // F√ºge Button unter dem Zitat hinzu
      quoteEl.insertAdjacentElement('afterend', editBtn);
    })();

    // Service Worker Registration (relative path for project pages)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>



