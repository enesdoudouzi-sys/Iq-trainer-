


<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daily IQ & Focus Trainer</title>
  <!-- Base href for GitHub Pages repo path (ensures relative assets resolve when site is served from /Iq-trainer-/) -->
  <base href="/Iq-trainer-/">

  <!-- PWA Meta Tags -->
  <meta name="application-name" content="IQ Trainer">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="IQ Trainer">
  <meta name="description" content="Trainiere tÃ¤glich deinen IQ und deine Konzentration">
  <meta name="theme-color" content="#00ffcc">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Content Security Policy (Basis, lokal erlaubt) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src https://fonts.gstatic.com; img-src 'self' data:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;" />
  
  <!-- Chart.js - mit defer fÃ¼r bessere Performance -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- Fonts - preconnect + preload for bessere Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  </noscript>

  <style>
    /* Theme Variables */
    :root[data-theme="dark"] {
      /* Dark base */
      --bg: #000000;
      --bg-gradient: radial-gradient(circle at top, #000000 0%, #050505 60%);
      /* Neoâ€‘TÃ¼rkis accents (primary + secondary) */
      --accent: #00ffd1; /* neon turquoise */
      --accent2: #00b8a5; /* slightly darker turquoise */
      --text: #e6fff9;
      --btn-text: #ffffff;
      --muted: #9fbfb6;
      --danger: #ff4d6a;
      /* Subtle card surfaces on dark */
      --card-bg: rgba(255,255,255,0.03);
      --card-border: rgba(0,223,210,0.08);
      --tutorial-bg: rgba(0,0,0,0.85);
    }
    
    :root[data-theme="light"] {
       --bg:#ffffff;
       --bg-gradient:linear-gradient(135deg, #f5f7fa 0%, #e8f0f7 100%);
       --accent:#00aa88;
       --accent2:#0088cc;
       --text:#222222;
       --btn-text:#fff;
       --muted:#666666;
       --danger:#cc3355;
       --card-bg:#ffffff;
       --card-border:#e0e6ed;
       --tutorial-bg:rgba(255,255,255,0.95);
     }    /* Tutorial Styles */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--tutorial-bg);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .tutorial-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .tutorial-content {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 500px;
      text-align: center;
      position: relative;
      animation: fadeInUp 0.5s ease;
    }

    .tutorial-step {
      display: none;
    }

    .tutorial-step.active {
      display: block;
    }

    .tutorial-buttons {
      margin-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .achievement-popup {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      z-index: 100;
    }

    .achievement-popup.show {
      transform: translateX(0);
    }

    .achievement-icon {
      font-size: 2rem;
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-title {
      color: var(--accent);
      font-weight: 600;
      margin: 0;
    }

    .achievement-desc {
      color: var(--muted);
      font-size: 0.9rem;
      margin: 0.2rem 0 0 0;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Existing styles... */
    *{box-sizing:border-box;transition:all .3s ease;}
    body{margin:0;background:var(--bg);background-image:var(--bg-gradient);background-repeat:no-repeat;background-attachment:fixed;color:var(--text);font-family:'Poppins',sans-serif;overflow-x:hidden;min-height:100vh;}
    header{padding:3rem 1rem 1rem;text-align:center;position:relative;}
    header h1{margin:0;font-size:3rem;text-transform:uppercase;font-family:'Orbitron',sans-serif;letter-spacing:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:glow 3s ease-in-out infinite alternate;}
    @keyframes quoteReveal {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        text-shadow: 0 0 0 rgba(0,255,204,0);
      }
      50% {
        opacity: 1;
        transform: translateY(0) scale(1);
        text-shadow: 0 0 20px rgba(0,255,204,0.4);
      }
      75% {
        text-shadow: 0 0 30px rgba(0,195,255,0.6);
      }
      100% {
        text-shadow: 0 0 20px rgba(0,255,204,0.4);
      }
    }

    header .quote {
      color: var(--accent);
      font-style: italic;
      font-size: 1.2rem;
      margin-top: 1rem;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
      font-weight: 500;
      text-wrap: balance;
      position: relative;
      animation: quoteReveal 4s ease-out;
      transition: all 0.3s ease;
      padding: 1rem;
      border-radius: 8px;
    }

    header .quote:hover {
      transform: translateY(-2px) scale(1.02);
      text-shadow: 0 0 30px rgba(0,255,204,0.6);
      background: rgba(0,255,204,0.05);
      border: 1px solid rgba(0,255,204,0.1);
    }

    header .quote::before,
    header .quote::after {
      content: '"';
      position: absolute;
      font-size: 2em;
      opacity: 0.5;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent2);
    }

    header .quote::before {
      left: -5px;
      top: -10px;
    }

    header .quote::after {
      right: -5px;
      bottom: -25px;
    }
    @keyframes glow{
      0%{text-shadow:0 0 10px var(--accent);}
      50%{text-shadow:0 0 20px var(--accent),0 0 30px var(--accent2);}
      100%{text-shadow:0 0 25px var(--accent2),0 0 35px var(--accent);}
    }
    @keyframes fadeIn{
      0%{opacity:0;transform:translateY(20px);}
      100%{opacity:1;transform:translateY(0);}
    }
    @keyframes pulse{
      0%{transform:scale(1);}
      50%{transform:scale(1.05);}
      100%{transform:scale(1);}
    }
    @keyframes slideIn{
      0%{transform:translateX(-20px);opacity:0;}
      100%{transform:translateX(0);opacity:1;}
    }
    @keyframes cardGlow{
      0%{box-shadow:0 0 15px rgba(0,255,200,0.2);}
      50%{box-shadow:0 0 25px rgba(0,255,200,0.4);}
      100%{box-shadow:0 0 15px rgba(0,255,200,0.2);}
    }

    .lang-switch{position:absolute;top:1rem;right:1rem;background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:.4rem .6rem;box-shadow:0 0 12px rgba(0,255,200,0.2);transition:all 0.3s ease;}
    .lang-switch:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,255,200,0.3);}
    .lang-switch select{background:transparent;border:none;color:var(--text);font-weight:600}

  main{max-width:1000px;margin:3rem auto;padding:2.5rem;background:#ffffff;border-radius:16px;border:1px solid #e0e6ed;box-shadow:0 2px 8px rgba(16,24,40,0.08);display:grid;grid-template-columns:1fr 280px;gap:2rem;}
    @media(max-width:900px){main{grid-template-columns:1fr;}}

    h2{color:var(--accent);font-family:'Orbitron',sans-serif;margin-top:0;text-align:left;font-size:1.5rem;}

    /* Tabs / Navigation */
    .tab-buttons{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem;justify-content:center;}

    /* Cards / Fragen */
    .question{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:16px;
      padding:1.4rem;
      margin:1rem 0;
      box-shadow:0 0 20px rgba(0,255,200,0.1);
      animation:fadeIn 0.5s ease-out, cardGlow 3s infinite;
      transform-origin:center;
      transition:all 0.3s ease;
    } 
    .question:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(0,255,200,0.2);
    }
    .question h3{
      margin-top:0;
      font-size:1.1rem;
      line-height:1.5;
      color:var(--text);
      animation:slideIn 0.5s ease-out;
    } 

    /* Buttons */
    button.option,button.start-btn,button.danger-btn,#consentOk{
      padding:0.7rem 1.3rem;
      border:none;
      border-radius:12px;
      cursor:pointer;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      background-size:200% 100%;
      color:var(--btn-text);
      font-weight:600;
      min-width:140px;
      font-size:1rem;
      box-shadow:0 0 15px rgba(0,255,200,0.4);
      transition:all 0.3s ease, background-position 0.5s ease;
    } 
    button.option:hover,button.start-btn:hover,button.danger-btn:hover,#consentOk:hover{
      transform:scale(1.08) translateY(-2px);
      box-shadow:0 8px 25px rgba(0,255,200,0.6);
      background-position:right center;
    }
    button.option:active,button.start-btn:active,button.danger-btn:active,#consentOk:active{
      transform:scale(0.98);
      box-shadow:0 2px 10px rgba(0,255,200,0.3);
    } 
    button.danger-btn{background:linear-gradient(90deg,var(--danger),#ff8b4d);box-shadow:0 0 15px rgba(255,77,106,0.5);color:#000;} 
    button.small{min-width:auto;font-size:.9rem;padding:.5rem 1rem;}

    .card-center{text-align:center;padding:2rem;background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;max-width:400px;margin:0 auto 2rem;box-shadow:0 0 20px rgba(0,255,200,0.1);} 
    .start-hint{color:var(--muted);font-size:.9rem;margin-top:.8rem;}

    /* Screens */
    .screen{
      display:none;
      opacity:0;
      transform:translateY(20px);
      transition:all 0.5s ease;
    }
    .screen.active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }

    .result-line{
      font-size:1.1rem;
      color:var(--accent);
      font-weight:500;
      min-height:1.4rem;
      animation:fadeIn 0.8s ease-out;
      transition:all 0.3s ease;
    }
    .result-line:hover{
      transform:scale(1.02);
      text-shadow:0 0 10px var(--accent);
    }

    /* Sidebar */
    aside .sidebar-card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:16px;
      padding:1rem;
      box-shadow:0 0 20px rgba(0,255,200,0.1);
      font-size:.9rem;
      animation:cardGlow 4s infinite;
      transition:all 0.3s ease;
    }
    aside .sidebar-card:hover{
      transform:translateY(-3px);
      box-shadow:0 10px 30px rgba(0,255,200,0.2);
    }
    .sidebar-title{
      margin-top:0;
      color:var(--accent);
      font-family:'Orbitron',sans-serif;
      font-size:0.8rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      animation:glow 3s infinite;
    }
    .sidebar-line{
      font-size:1rem;
      color:var(--text);
      transition:all 0.3s ease;
      animation:slideIn 0.5s ease-out;
    } 
    /* Help / Psycho content */
    .help-block{
      margin-top:1rem;
      padding:1rem;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      border-radius:12px;
      text-align:center;
    }
    .breath-circle{
      width:120px;height:120px;border-radius:50%;margin:0.6rem auto;background:radial-gradient(circle at 30% 30%, var(--accent), var(--accent2));
      opacity:0.95;transition:transform 4s ease-in-out;
    }
    .breath-controls{display:flex;gap:.5rem;justify-content:center;margin-top:.5rem}
    .transcript{font-size:.95rem;color:var(--muted);text-align:left;margin-top:.8rem;padding:.6rem;border-radius:8px;background:rgba(0,0,0,0.03)}
    /* Respect users who prefer reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
      .breath-circle { transition: none !important; }
    }
    .sidebar-line:hover{
      color:var(--accent);
      transform:translateX(5px);
    }
    .sidebar-note{
      color:var(--muted);
      font-size:.8rem;
      transition:all 0.3s ease;
    }
    .ai-tip{
      margin-top:.6rem;
      color:var(--accent2);
      font-weight:600;
      animation:pulse 2s infinite;
      transition:all 0.3s ease;
    }
    .ai-tip:hover{
      transform:scale(1.02);
      color:var(--accent);
    }

    /* Statistik */
    .stats-block{background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px;padding:1rem;margin-bottom:1rem;font-size:.95rem;box-shadow:0 0 16px rgba(0,255,200,0.08);} 
    .stats-block h3{margin-top:0;font-size:1rem;color:var(--accent);font-family:'Orbitron',sans-serif;letter-spacing:.05em;}
    .history-list{list-style:none;padding-left:1rem;color:var(--text);font-size:.9rem;} 
    .history-list li{margin-bottom:.4rem;color:var(--muted);} 

    footer{text-align:center;padding:1.5rem 1rem;color:var(--muted);font-size:0.9rem;margin-top:4rem;grid-column:1 / -1;}

    /* Consent Banner */
    .consent-banner{position:fixed;left:1rem;right:1rem;bottom:1rem;background:#000;border:1px solid var(--card-border);box-shadow:0 0 20px rgba(0,255,200,0.4);border-radius:14px;padding:1rem;font-size:.8rem;color:var(--text);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;max-width:600px;margin:0 auto;z-index:9999;}
  </style>
</head>
<body>
  <!-- Tutorial Overlay -->
  <div class="tutorial-overlay" id="tutorial">
    <div class="tutorial-content">
      <div class="tutorial-step" data-step="1">
        <h2>Willkommen beim IQ & Focus Trainer! ğŸ‘‹</h2>
        <p>Lass uns gemeinsam deine mentalen FÃ¤higkeiten trainieren. Ich zeige dir kurz, wie alles funktioniert.</p>
      </div>
      <div class="tutorial-step" data-step="2">
        <h2>IQ Tests ğŸ§ </h2>
        <p>Fordere dein logisches Denken heraus. WÃ¤hle verschiedene Schwierigkeitsgrade und Kategorien.</p>
      </div>
      <div class="tutorial-step" data-step="3">
        <h2>Psyche-Check ğŸ¯</h2>
        <p>Behalte dein mentales Wohlbefinden im Blick und erhalte personalisierte Tipps.</p>
      </div>
      <div class="tutorial-step" data-step="4">
        <h2>Statistiken & Erfolge ğŸ“Š</h2>
        <p>Verfolge deinen Fortschritt und sammle Achievements fÃ¼r besondere Leistungen.</p>
      </div>
      <div class="tutorial-buttons">
        <button class="option" id="tutorialPrev">ZurÃ¼ck</button>
        <button class="option" id="tutorialNext">Weiter</button>
      </div>
    </div>
  </div>

  <!-- Theme & Language Controls -->
  <div class="theme-controls" style="position:fixed;top:1rem;left:1rem;z-index:100;display:flex;gap:1rem;">
    <button id="themeToggle" class="option small" style="min-width:auto;padding:0.4rem">
      <span id="themeIcon">ğŸŒ™</span>
    </button>
  </div>

  <header>
    <div class="lang-switch">
      <select id="langSelect" aria-label="Language">
        <option value="de" selected>ğŸ‡©ğŸ‡ª Deutsch</option>
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
      </select>
    </div>
    <p class="quote">â€Der Mensch ist der Mittelpunkt der Welt, weil er denkt.â€œ â€“ Ibn Sina (Avicenna)</p>
    <h1>Daily IQ & Focus Trainer</h1>
  </header>

  <main>
    <section id="contentArea">
      <!-- Navigation Buttons -->
      <div class="tab-buttons">
        <button data-screen="intro" class="option" id="tabStart">Start</button>
        <button data-screen="iqTest" class="option" id="tabIQ">IQâ€‘Test</button>
        <button data-screen="psyTest" class="option" id="tabPsy">Psyche</button>
        <button data-screen="daily" class="option" id="tabDaily">ğŸ¯ Daily</button>
        <button data-screen="stats" class="option" id="tabStats">Statistik</button>
        <button data-screen="settings" class="option" id="tabSettings">âš™ï¸ Einstellungen</button>
      </div>

      <!-- Difficulty & Category Selection -->
      <div id="testSettings" style="display:none;margin-bottom:2rem;animation:fadeIn 0.5s ease;">
        <div class="difficulty-select" style="margin-bottom:1rem;">
          <h3 style="color:var(--accent);margin-bottom:0.8rem;">Schwierigkeitsgrad</h3>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="option small" data-difficulty="easy">Einfach</button>
            <button class="option small" data-difficulty="medium">Mittel</button>
            <button class="option small" data-difficulty="hard">Schwer</button>
          </div>
        </div>
        
        <div class="category-select">
          <h3 style="color:var(--accent);margin-bottom:0.8rem;">Kategorie</h3>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="option small" data-category="logic">ğŸ§© Logik</button>
            <button class="option small" data-category="math">ğŸ”¢ Mathematik</button>
            <button class="option small" data-category="pattern">ğŸ“Š Muster</button>
            <button class="option small" data-category="verbal">ğŸ“š Sprache</button>
            <button class="option small" data-category="memory">ğŸ§  GedÃ¤chtnis</button>
          </div>
        </div>
      </div>

      <!-- INTRO / START -->
      <section id="intro" class="screen active">
        <div class="card-center">
          <button id="startBtn" class="start-btn">Test starten</button>
          <p class="start-hint" id="hintLocal">Deine Ergebnisse werden nur lokal auf deinem GerÃ¤t gespeichert.</p>
        </div>
      </section>

      <!-- IQ TEST -->
      <section id="iqTest" class="screen">
        <h2 id="iqTitle">IQâ€‘Test</h2>
        <div id="iqQuestions"></div>
        <p id="iqResult" class="result-line"></p>
        <div id="iqHelp" class="help-block" aria-live="polite" style="display:none">
          <!-- Dynamically populated help content for IQ results -->
          <div id="iqHelpContent"></div>
          <div class="transcript" id="iqTranscript" style="display:none"></div>
        </div>
      </section>

      <!-- PSYCHE TEST -->
      <section id="psyTest" class="screen">
        <h2 id="psyTitle">Psycheâ€‘Analyse</h2>
        <div id="psyQuestions"></div>
        <p id="psyResult" class="result-line"></p>
        <div id="psyHelp" class="help-block" aria-live="polite" style="display:none">
          <div id="psyHelpContent"></div>
          <div class="transcript" id="psyTranscript" style="display:none"></div>
        </div>
      </section>

      <!-- DAILY CHALLENGE -->
      <section id="daily" class="screen">
        <h2>ğŸ¯ Daily Challenge</h2>
        <div id="dailyContent" class="question">
          <div id="dailyStatus" style="text-align:center; margin-bottom:1rem;"></div>
          <div id="dailyQuestion"></div>
        </div>
        <div id="dailyResult" class="result-line"></div>
        <div class="stats-block" style="margin-top:2rem;">
          <h3>ğŸ† Daily Streaks</h3>
          <div id="streakInfo"></div>
        </div>
      </section>

      <!-- STATS / VERLAUF -->
      <section id="stats" class="screen">
        <h2 id="statsTitle">Deine Statistik</h2>
        
        <!-- Ãœbersichts-Karten -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-bottom:2rem;">
          <!-- IQ Ãœbersicht -->
          <div class="stats-block" style="text-align:center;">
            <h3 style="color:var(--accent)">ğŸ§  IQ Performance</h3>
            <div style="font-size:2rem; margin:1rem 0; color:var(--accent)" id="avgIQScore">--%</div>
            <div style="color:var(--muted)" id="totalIQTests">0 Tests absolviert</div>
          </div>
          
            <!-- Category breakdown -->
            <div class="stats-block" style="text-align:center;" id="categoryBreakdownBlock">
              <h3 style="color:var(--accent)">ğŸ“‚ Kategorienâ€‘Score</h3>
              <div id="categoryBreakdown" style="color:var(--muted); font-size:0.95rem">Noch keine Daten</div>
            </div>
          
          <!-- Psyche Ãœbersicht -->
          <div class="stats-block" style="text-align:center;">
            <h3 style="color:var(--accent2)">ğŸ¯ Psyche Status</h3>
            <div style="font-size:2rem; margin:1rem 0; color:var(--accent2)" id="currentStressLevel">--</div>
            <div style="color:var(--muted)" id="totalPsyTests">0 Tests absolviert</div>
          </div>
        </div>

        <!-- Detaillierte Statistiken -->
        <div class="stats-block">
          <h3 style="margin-bottom:1rem;">ğŸ“Š Aktuelle Leistung</h3>
          <div><strong id="labelLastIQ">Letzter IQâ€‘Score:</strong> <span id="statLastIQ">â€“</span></div>
          <div><strong id="labelLastPsy">Letzte Psycheâ€‘Einstufung:</strong> <span id="statPsyLevel">â€“</span></div>
          <div style="margin-top:1rem;"><strong>Trend:</strong> <span id="performanceTrend">â€“</span></div>
        </div>

        <!-- Verlauf mit Zeitfilter -->
        <div class="stats-block">
          <h3 id="historyH3" style="margin-bottom:1rem;">ğŸ“… Verlauf</h3>
          <div class="history-filter" style="margin-bottom:1rem;">
            <button class="option small" data-filter="week">Diese Woche</button>
            <button class="option small" data-filter="month">Dieser Monat</button>
            <button class="option small" data-filter="all">Alle Zeit</button>
          </div>
          <ul id="historyList" class="history-list"></ul>
        </div>

        <div class="stats-block">
          <h3>ğŸ† Highscore</h3>
          <div><strong>Beste IQâ€‘Scores:</strong>
            <ol id="highscoreIQ" class="history-list"></ol>
          </div>
          <div style="margin-top:1rem"><strong>Beste Psycheâ€‘Scores:</strong>
            <ol id="highscorePsy" class="history-list"></ol>
          </div>
        </div>

        <div class="stats-block">
          <h3>ğŸ“ˆ Fortschritt</h3>
          <div class="chart-container" style="position:relative; height:300px; width:100%; margin-top:1rem;">
            <canvas id="progressChart"></canvas>
          </div>
          <div class="chart-container" style="position:relative; height:300px; width:100%; margin-top:2rem;">
            <canvas id="stressChart"></canvas>
          </div>
        </div>

        <button id="clearDataBtn" class="danger-btn">Alle gespeicherten Daten lÃ¶schen</button>
        <button id="seedDemoBtn" class="start-btn small" style="margin-left:0.6rem">Demo-Daten einfÃ¼gen</button>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="screen">
        <h2>âš™ï¸ Einstellungen</h2>
        
        <div class="stats-block">
          <h3>ğŸ« AtemÃ¼bung konfigurieren</h3>
          <p style="color:var(--muted);margin-bottom:1rem">Passe die Dauer der AtemÃ¼bung nach deinen Vorlieben an:</p>
          
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1.5rem">
            <div>
              <label for="breathInhale" style="display:block;margin-bottom:0.5rem;color:var(--accent);font-weight:600">Einatmen (Sekunden)</label>
              <input type="range" id="breathInhale" min="2" max="8" step="1" style="width:100%"/>
              <div style="text-align:center;color:var(--accent2);margin-top:0.3rem"><span id="breathInhaleValue">4</span>s</div>
            </div>
            <div>
              <label for="breathHold" style="display:block;margin-bottom:0.5rem;color:var(--accent);font-weight:600">Halten (Sekunden)</label>
              <input type="range" id="breathHold" min="2" max="8" step="1" style="width:100%"/>
              <div style="text-align:center;color:var(--accent2);margin-top:0.3rem"><span id="breathHoldValue">4</span>s</div>
            </div>
            <div>
              <label for="breathExhale" style="display:block;margin-bottom:0.5rem;color:var(--accent);font-weight:600">Ausatmen (Sekunden)</label>
              <input type="range" id="breathExhale" min="2" max="8" step="1" style="width:100%"/>
              <div style="text-align:center;color:var(--accent2);margin-top:0.3rem"><span id="breathExhaleValue">4</span>s</div>
            </div>
            <div>
              <label for="breathHoldAfter" style="display:block;margin-bottom:0.5rem;color:var(--accent);font-weight:600">Pause danach (Sekunden)</label>
              <input type="range" id="breathHoldAfter" min="0" max="4" step="1" style="width:100%"/>
              <div style="text-align:center;color:var(--accent2);margin-top:0.3rem"><span id="breathHoldAfterValue">0</span>s</div>
            </div>
          </div>

          <div style="display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap">
            <button class="start-btn" id="breathTestBtn">AtemÃ¼bung testen</button>
            <button class="option" id="breathResetBtn">Auf Standard zurÃ¼cksetzen</button>
          </div>
        </div>

        <div class="stats-block">
          <h3>ğŸ”” Benachrichtigungen</h3>
          <p style="color:var(--muted);margin-bottom:1rem">Passe deine tÃ¤glichen Erinnerungen an:</p>
          
          <div style="margin-bottom:1rem">
            <label style="display:flex;align-items:center;gap:0.6rem;cursor:pointer;color:var(--text)">
              <input type="checkbox" id="notifEnabled" style="cursor:pointer"/>
              <span>TÃ¤gliche Benachrichtigungen aktivieren</span>
            </label>
          </div>

          <div>
            <label for="notifTime" style="display:block;margin-bottom:0.5rem;color:var(--accent);font-weight:600">Benachrichtigungszeit</label>
            <input type="time" id="notifTime" style="padding:0.6rem;border-radius:8px;background:var(--card-bg);color:var(--text);border:1px solid var(--card-border)"/>
          </div>
        </div>

        <div class="stats-block">
          <h3>ğŸ“Š Datenmanagement</h3>
          <p style="color:var(--muted);margin-bottom:1rem">Exportiere oder lÃ¶sche deine Daten:</p>
          
          <div style="display:flex;gap:1rem;flex-wrap:wrap">
            <button class="start-btn" id="exportDataBtn">ğŸ“¥ Daten exportieren (JSON)</button>
            <button class="option" id="importDataBtn">ğŸ“¤ Daten importieren</button>
              <button class="option" id="addQuestionBtn">â• Frage hinzufÃ¼gen</button>
            <input type="file" id="importFile" accept=".json" style="display:none"/>
          </div>
          <p style="color:var(--muted);font-size:0.9rem;margin-top:0.6rem">Deine Daten werden in eine JSON-Datei exportiert, die du sicher speichern kannst.</p>
        </div>

        <div class="stats-block">
          <h3>â„¹ï¸ Ãœber die App</h3>
          <div style="color:var(--muted);line-height:1.6">
            <div><strong>Version:</strong> 2.0.0</div>
            <div><strong>Speicher:</strong> <span id="storageInfo">â€“</span></div>
            <div style="margin-top:0.6rem;font-size:0.9rem">Alle Daten werden lokal in deinem Browser gespeichert. Keine Serversynchronisation.</div>
          </div>
        </div>
      </section>
    </section>

    <!-- SIDEBAR -->
    <aside>
      <div class="sidebar-card">
        <h4 class="sidebar-title" id="liveStatusTitle">Live Status</h4>
        <div class="sidebar-line" id="lblActive">Aktiver Test: <span id="liveTest">â€“</span></div>
        <div class="sidebar-line" id="lblQuestion">Frage #: <span id="liveQuestion">0</span></div>
        <div class="sidebar-line" id="lblScore">Score: <span id="liveScore">0</span></div>
        <div class="sidebar-note" id="liveNote">Bereit.</div>
        <div class="ai-tip" id="aiTip">ğŸ¤– KIâ€‘Tipp erscheint nach dem Test.</div>
      </div>
    </aside>

    <footer>Â© 2025 Daily IQ & Focus Trainer</footer>
  </main>

  <!-- CONSENT-BANNER (DSGVO Style) -->
  <div id="consentBanner" class="consent-banner">
    <div id="consentText">Lokale Auswertung aktiv. Deine Ergebnisse bleiben nur in deinem Browser (LocalStorage).</div>
    <button id="consentOk" class="start-btn small">OK</button>
  </div>

  <script>
    // =====================
    // Sound Effects
    // =====================
    const correctSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAUAAAnhgAGBg0NDRQUGxsbIiIiKSkpMDAwNzc3Pj4+RUVFTU1NVFRUTU1NRUVFPj4+NjY2Ly8vKCgoISEhGhoaExMTDAwMBgYGAAAAAAAA//tQxAADB3AJH4AAABBAmBk/gAAAEHN3dy93d3d3d3d3d3d3d3d3d3dwAAd3d3d3d3d3d3d3d3d3d3d3d3AHd3d3d3d3d3d3d3d3d3d3d3d3cAB3d3d3d3d3d3d3d3d3d3d3d3dwAAA=');
    const incorrectSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAUAAAnhgAGBg0NDRQUGxsbIiIiKSkpMDAwNzc3Pj4+RUVFTU1NVFRUTU1NRUVFPj4+NjY2Ly8vKCgoISEhGhoaExMTDAwMBgYGAAAAAAAA//tQxAADB3AJH4AAABBAmBk/gAAAEBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU');

    // =====================
    // i18n Texte & Fragen
    // =====================
    const i18n = {
      de: {
        ui: {
          start:'Start', iq:'IQâ€‘Test', psy:'Psyche', stats:'Statistik',
          introHint:'Deine Ergebnisse werden nur lokal auf deinem GerÃ¤t gespeichert.',
          live:{ title:'Live Status', ready:'Bereit.', activeIQ:'IQâ€‘Test', activePsy:'Psyche' },
          labels:{ lastIQ:'Letzter IQâ€‘Score:', lastPsy:'Letzte Psycheâ€‘Einstufung:', history:'Historie' },
          results:{
            iq:(s,t)=>`Dein IQâ€‘Score: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=24?'Sehr entspannt': tot<=40?'Leichte Anspannung':tot<=56?'Mittleres Stresslevel':'ErhÃ¶htes Stresslevel'
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? 'Stark! Logik & Muster sitzen.' : s/t>=0.5 ? 'Gute Basis. Tempo & Genauigkeit weiter ausbauen.' : 'Back to basics: Kopfrechnen & Muster trainieren.',
            psy:(lvl)=> lvl.includes('ErhÃ¶ht') ? 'Heute 5â€‘Minutenâ€‘Atmung + kurzer Walk.' : lvl.includes('Leichte') ? '45â€‘Minutenâ€‘Fokus, dann Miniâ€‘Break.' : 'Stabil â€“ Routinen beibehalten.'
          },
          compare:{ better:(c)=>`Ãœberdurchschnittlich im Vergleich zu ${c}.`, avg:(c)=>`Etwa im Durchschnitt von ${c}.`, worse:(c)=>`Unterdurchschnittlich im Vergleich zu ${c}.` }
        },
        iq: [
          {q:'Was ist 9 Ã— 9?',a:['72','81','99'],c:1},
          {q:'Was ergibt 5Â³?',a:['25','125','225'],c:1},
          {q:'Welche Zahl folgt: 2,4,8,16,?',a:['24','32','36'],c:1},
          {q:'WÃ¤hle das Gegenteil von â€chaotisch"',a:['geordnet','hektisch','nervÃ¶s'],c:0},
          {q:'Was ist 20% von 400?',a:['40','60','80'],c:2},
          {q:'Welche Zahl vervollstÃ¤ndigt: 3,6,9,12,?',a:['13','14','15'],c:2},
          {q:'Was ist 12 Ã— 12?',a:['124','144','132'],c:1},
          {q:'Wurzel aus 81?',a:['7','8','9'],c:2},
          {q:'Wie viele Sekunden hat eine Stunde?',a:['3600','6000','1800'],c:0},
          {q:'Welches Wort passt nicht in die Reihe?',a:['Apfel','Banane','Karotte','Orange'],c:2},
          {q:'Was ist 15 Ã— 15?',a:['215','225','235'],c:1},
          {q:'Welche Zahl fehlt: 1,4,9,16,?',a:['20','25','36'],c:2},
          {q:'7 Ã— 8 + 3 = ?',a:['53','56','59'],c:2},
          {q:'Was ist die Wurzel aus 144?',a:['10','12','14'],c:1},
          {q:'VervollstÃ¤ndige die Reihe: 2,6,18,?',a:['36','54','72'],c:2},
          {q:'Ein Zug fÃ¤hrt 250 km/h. Wie weit kommt er in 2 Stunden?',a:['400km','500km','600km'],c:1},
          {q:'Was ist das Gegenteil von "optimistisch"?',a:['realistisch','pessimistisch','skeptisch'],c:1},
          {q:'Welche Zahl ist durch 2, 3 und 4 teilbar?',a:['12','18','24'],c:2},
          {q:'Was ergibt (4 Ã— 4) Ã— (2 Ã— 2)?',a:['48','64','96'],c:1},
          {q:'Wenn 3 Ã„pfel 2â‚¬ kosten, wie viel kosten 9 Ã„pfel?',a:['6â‚¬','9â‚¬','12â‚¬'],c:0},
          {q:'VervollstÃ¤ndige: A, C, F, J, ?',a:['O','N','M'],c:1},
          {q:'Was ist 1000 geteilt durch 25?',a:['25','40','75'],c:1},
          {q:'Welche Form hat vier Seiten und alle Winkel 90Â°?',a:['Rechteck','Raute','Dreieck'],c:0},
          {q:'VervollstÃ¤ndige die Reihe: 5,10,20,40,?',a:['50','60','80'],c:2},
          {q:'Welche Zahl ist Prim (kleinste Zahl grÃ¶ÃŸer als 1)?',a:['2','1','0'],c:0},
          {q:'Was ist die Quadratwurzel von 169?',a:['12','13','14'],c:1}
    ,
    {q:'Wenn ein Rechteck 5 cm breit und 8 cm lang ist, wie groÃŸ ist die FlÃ¤che?',a:['40','13','20'],c:0,cat:'math'},
    {q:'Welche Zahl vervollstÃ¤ndigt die Reihe: 4,9,16,25,?',a:['30','36','49'],c:1,cat:'pattern'},
    {q:'Wenn jede Stunde 60 Minuten hat, wie viele Minuten hat ein halber Tag?',a:['720','600','480'],c:0,cat:'math'},
    {q:'Welches Wort passt thematisch nicht: Lehrer, SchÃ¼ler, Stift, Tafel?',a:['Stift','SchÃ¼ler','Tafel'],c:0,cat:'verbal'},
    {q:'Merke dir folgende Zahlen: 3,7,2. Welche Zahl stand in der Mitte?',a:['3','7','2'],c:1,cat:'memory'},
    {q:'Setze fort: 2,3,5,7,11,?',a:['12','13','15'],c:1,cat:'logic'}
    ],
        psy: [
          {q:'Wie oft fÃ¼hlst du dich unter Druck?',a:['Nie','Selten','Manchmal','Oft','Sehr oft'],s:[1,2,3,4,5]},
          {q:'Kannst du gut abschalten?',a:['Ja','Meistens','Teilweise','Selten','Nein'],s:[1,2,3,4,5]},
          {q:'Wie stabil fÃ¼hlst du dich in Konflikten?',a:['Sehr stabil','Stabil','Unsicher','Instabil','Sehr instabil'],s:[1,2,3,4,5]},
          {q:'Wie erholt fÃ¼hlst du dich morgens?',a:['Sehr','Gut','Geht so','MÃ¼de','ErschÃ¶pft'],s:[1,2,3,4,5]},
          {q:'Wie hÃ¤ufig grÃ¼belst du?',a:['Nie','Selten','Manchmal','Oft','StÃ¤ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut gelingt dir Fokus ohne Ablenkung?',a:['Sehr gut','Gut','Okay','Schwer','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie ausgeglichen ist deine Stimmung?',a:['Sehr','Ziemlich','Teils','Eher nicht','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie ist dein Stress aktuell?',a:['Sehr niedrig','Niedrig','Mittel','Hoch','Sehr hoch'],s:[1,2,3,4,5]},
          {q:'Wie gut schlÃ¤fst du nachts?',a:['Sehr gut','Gut','MittelmÃ¤ÃŸig','Schlecht','Sehr schlecht'],s:[1,2,3,4,5]},
          {q:'Wie oft hast du Kopfschmerzen?',a:['Nie','Selten','Gelegentlich','HÃ¤ufig','Sehr hÃ¤ufig'],s:[1,2,3,4,5]},
          {q:'Wie zufrieden bist du mit deiner Work-Life-Balance?',a:['Sehr','Ziemlich','Mittel','Wenig','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie oft fÃ¼hlst du dich Ã¼berfordert?',a:['Nie','Selten','Manchmal','Oft','StÃ¤ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut kannst du "Nein" sagen?',a:['Sehr gut','Gut','Mittel','Schwer','Sehr schwer'],s:[1,2,3,4,5]},
          {q:'Wie oft nimmst du dir Zeit fÃ¼r dich selbst?',a:['TÃ¤glich','Oft','Manchmal','Selten','Nie'],s:[1,2,3,4,5]},
          {q:'Wie hÃ¤ufig fÃ¼hlst du dich energielos?',a:['Nie','Selten','Manchmal','Oft','StÃ¤ndig'],s:[1,2,3,4,5]},
          {q:'Wie gut kannst du PrioritÃ¤ten setzen?',a:['Sehr gut','Gut','Mittel','Schwer','Sehr schwer'],s:[1,2,3,4,5]},
          {q:'Wie schnell erholst du dich von Stress?',a:['Sofort','Schnell','MÃ¤ÃŸig','Langsam','Sehr langsam'],s:[1,2,3,4,5]},
          {q:'Wie oft nimmst du Pausen wÃ¤hrend der Arbeit?',a:['RegelmÃ¤ÃŸig','Oft','Manchmal','Selten','Nie'],s:[1,2,3,4,5]},
          {q:'Wie gut planst du deinen Tag im Voraus?',a:['Sehr gut','Gut','Okay','Schwach','Gar nicht'],s:[1,2,3,4,5]},
          {q:'Wie sehr beeinflusst Schlaf deine LeistungsfÃ¤higkeit?',a:['Gar nicht','Wenig','Mittel','Stark','Sehr stark'],s:[1,2,3,4,5]},
          {q:'Wie oft fÃ¼hlst du dich energiegeladen?',a:['TÃ¤glich','Mehrmals/Woche','Manchmal','Selten','Nie'],s:[1,2,3,4,5]}
        ]
      },
      es: {
        ui: {
          start:"Comenzar", iq:"Test de CI", psy:"Psique", stats:"EstadÃ­sticas",
          introHint:"Tus resultados se almacenan solo en tu navegador.",
          live:{ title:"Estado en Vivo", ready:"Listo.", activeIQ:"Test de CI", activePsy:"Test Psique" },
          labels:{ lastIQ:"Ãšltimo CI:", lastPsy:"Ãšltimo Nivel Psique:", history:"Historial" },
          results:{
            iq:(s,t)=>`Tu puntuaciÃ³n CI: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=12?"Muy relajado": tot<=20?"TensiÃ³n leve":"EstrÃ©s elevado"
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? "Â¡Excelente! LÃ³gica y patrones dominados." : s/t>=0.5 ? "Buena base. Mejora velocidad y precisiÃ³n." : "Volver a lo bÃ¡sico: cÃ¡lculo mental y patrones.",
            psy:(lvl)=> lvl.includes("elevado") ? "Intenta 5min de respiraciÃ³n + caminar." : lvl.includes("leve") ? "45min de concentraciÃ³n, luego micro-pausa." : "Estable â€“ mantÃ©n tus rutinas."
          },
          compare:{ better:(c)=>`Por encima del promedio vs ${c}.`, avg:(c)=>`En el promedio de ${c}.`, worse:(c)=>`Por debajo del promedio vs ${c}.` }
        },
        iq: [
          {q:"Â¿CuÃ¡nto es 9 Ã— 9?",a:["72","81","99"],c:1},
          {q:"Â¿CuÃ¡nto es 5Â³?",a:["25","125","225"],c:1},
          {q:"Â¿QuÃ© nÃºmero sigue: 2,4,8,16,?",a:["24","32","36"],c:1},
          {q:"Elige lo opuesto a \"caÃ³tico\"",a:["ordenado","agitado","nervioso"],c:0},
          {q:"Â¿CuÃ¡nto es el 20% de 400?",a:["40","60","80"],c:2},
          {q:"Completa: 3,6,9,12,?",a:["13","14","15"],c:2},
          {q:"Â¿CuÃ¡nto es 12 Ã— 12?",a:["124","144","132"],c:1},
          {q:"Â¿RaÃ­z cuadrada de 81?",a:["7","8","9"],c:2},
          {q:"Â¿CuÃ¡ntos segundos hay en una hora?",a:["3600","6000","1800"],c:0},
            {q:"Si 4 bolÃ­grafos cuestan 3â‚¬, Â¿cuÃ¡nto cuestan 12?",a:["6â‚¬","9â‚¬","12â‚¬"],c:1},
            {q:'Si un rectÃ¡ngulo mide 5 cm de ancho y 8 cm de largo, Â¿cuÃ¡l es su Ã¡rea?',a:['40','13','20'],c:0,cat:'math'},
            {q:'Â¿QuÃ© nÃºmero completa la serie: 4,9,16,25,?',a:['30','36','49'],c:1,cat:'pattern'},
            {q:'Si un dÃ­a tiene 24 horas, Â¿cuÃ¡ntos minutos tiene medio dÃ­a?',a:['720','600','480'],c:0,cat:'math'},
            {q:'Â¿CuÃ¡l palabra no pertenece: maestro, alumno, bolÃ­grafo, pizarra?',a:['bolÃ­grafo','alumno','pizarra'],c:0,cat:'verbal'},
            {q:'Recuerda los nÃºmeros: 3,7,2. Â¿CuÃ¡l estaba en el medio?',a:['3','7','2'],c:1,cat:'memory'},
            {q:'ContinÃºa: 2,3,5,7,11,?',a:['12','13','15'],c:1,cat:'logic'}
        ],
        psy: [
          {q:"Â¿Con quÃ© frecuencia te sientes bajo presiÃ³n?",a:["Nunca","Raramente","A veces","A menudo","Muy a menudo"],s:[1,2,3,4,5]},
          {q:"Â¿Puedes desconectar fÃ¡cilmente?",a:["SÃ­","Mayormente","A veces","Raramente","No"],s:[1,2,3,4,5]},
          {q:"Â¿CÃ³mo manejas los conflictos?",a:["Muy estable","Estable","Inseguro","Inestable","Muy inestable"],s:[1,2,3,4,5]},
          {q:"Â¿CÃ³mo te sientes por la maÃ±ana?",a:["Muy descansado","Bien","Regular","Cansado","Agotado"],s:[1,2,3,4,5]},
          {q:"Â¿Con quÃ© frecuencia te preocupas?",a:["Nunca","Raramente","A veces","A menudo","Constantemente"],s:[1,2,3,4,5]},
          {q:"Tu concentraciÃ³n sin distracciones es:",a:["Excelente","Buena","Regular","DifÃ­cil","Imposible"],s:[1,2,3,4,5]},
          {q:"Â¿Tu estado de Ã¡nimo es equilibrado?",a:["Mucho","Bastante","A veces","No mucho","Nada"],s:[1,2,3,4,5]},
          {q:"Â¿CuÃ¡l es tu nivel de estrÃ©s actual?",a:["Muy bajo","Bajo","Medio","Alto","Muy alto"],s:[1,2,3,4,5]}
        ]
      },
      tr: {
        ui: {
          start:"BaÅŸla", iq:"IQ Testi", psy:"Psikoloji", stats:"Ä°statistikler",
          introHint:"SonuÃ§larÄ±nÄ±z yalnÄ±zca tarayÄ±cÄ±nÄ±zda saklanÄ±r.",
          live:{ title:"CanlÄ± Durum", ready:"HazÄ±r.", activeIQ:"IQ Testi", activePsy:"Psikoloji Testi" },
          labels:{ lastIQ:"Son IQ PuanÄ±:", lastPsy:"Son Psikoloji Seviyesi:", history:"GeÃ§miÅŸ" },
          results:{
            iq:(s,t)=>`IQ puanÄ±nÄ±z: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=12?"Ã‡ok rahat": tot<=20?"Hafif gerginlik":"YÃ¼ksek stres"
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? "Harika! GÃ¼Ã§lÃ¼ mantÄ±k ve Ã¶rÃ¼ntÃ¼ler." : s/t>=0.5 ? "SaÄŸlam temel. HÄ±z ve doÄŸruluÄŸu geliÅŸtir." : "Temellere dÃ¶n: zihinsel matematik ve Ã¶rÃ¼ntÃ¼ler.",
            psy:(lvl)=> lvl.includes("YÃ¼ksek") ? "5 dakika nefes + kÄ±sa yÃ¼rÃ¼yÃ¼ÅŸ dene." : lvl.includes("Hafif") ? "45 dakika odaklan, sonra mikro-mola." : "Stabil â€“ rutinleri koru."
          },
          compare:{ better:(c)=>`${c} ortalamasÄ±nÄ±n Ã¼stÃ¼nde.`, avg:(c)=>`${c} ortalamasÄ±nda.`, worse:(c)=>`${c} ortalamasÄ±nÄ±n altÄ±nda.` }
        },
        iq: [
          {q:"9 Ã— 9 kaÃ§tÄ±r?",a:["72","81","99"],c:1},
          {q:"5Â³ kaÃ§tÄ±r?",a:["25","125","225"],c:1},
          {q:"Hangi sayÄ± gelir: 2,4,8,16,?",a:["24","32","36"],c:1},
          {q:"\"Kaotik\"in zÄ±ttÄ±nÄ± seÃ§in",a:["dÃ¼zenli","telaÅŸlÄ±","gergin"],c:0},
          {q:"400\'Ã¼n %20\'si kaÃ§tÄ±r?",a:["40","60","80"],c:2},
          {q:"TamamlayÄ±n: 3,6,9,12,?",a:["13","14","15"],c:2},
          {q:"12 Ã— 12 kaÃ§tÄ±r?",a:["124","144","132"],c:1},
          {q:"81\'in karekÃ¶kÃ¼?",a:["7","8","9"],c:2},
          {q:"Bir saatte kaÃ§ saniye vardÄ±r?",a:["3600","6000","1800"],c:0},
          {q:"4 kalem 3TL ise, 12 kalem kaÃ§ TL?",a:["6TL","9TL","12TL"],c:1},
          {q:'EÄŸer bir dikdÃ¶rtgen 5 cm geniÅŸliÄŸinde ve 8 cm uzunluÄŸunda ise, alanÄ± kaÃ§ cmÂ²dir?',a:['40','13','20'],c:0,cat:'math'},
          {q:'Seriyi tamamlayÄ±n: 4,9,16,25,?',a:['30','36','49'],c:1,cat:'pattern'},
          {q:'Bir gÃ¼n 24 saatse, yarÄ±m gÃ¼n kaÃ§ dakikadÄ±r?',a:['720','600','480'],c:0,cat:'math'},
          {q:'Hangi kelime ait deÄŸil: Ã¶ÄŸretmen, Ã¶ÄŸrenci, kalem, tahta?',a:['kalem','Ã¶ÄŸrenci','tahta'],c:0,cat:'verbal'},
          {q:'SayÄ±larÄ± hatÄ±rla: 3,7,2. Ortada hangi sayÄ± vardÄ±?',a:['3','7','2'],c:1,cat:'memory'},
          {q:'Devam et: 2,3,5,7,11,?',a:['12','13','15'],c:1,cat:'logic'}
        ],
        psy: [
          {q:"Ne sÄ±klÄ±kla baskÄ± altÄ±nda hissediyorsunuz?",a:["HiÃ§bir zaman","Nadiren","Bazen","SÄ±k sÄ±k","Ã‡ok sÄ±k"],s:[1,2,3,4,5]},
          {q:"Ä°ÅŸten kopabiliyor musunuz?",a:["Evet","Ã‡oÄŸunlukla","KÄ±smen","Nadiren","HayÄ±r"],s:[1,2,3,4,5]},
          {q:"Ã‡atÄ±ÅŸmalarÄ± nasÄ±l yÃ¶netiyorsunuz?",a:["Ã‡ok stabil","Stabil","KararsÄ±z","Dengesiz","Ã‡ok dengesiz"],s:[1,2,3,4,5]},
          {q:"SabahlarÄ± kendinizi nasÄ±l hissediyorsunuz?",a:["Ã‡ok dinÃ§","Ä°yi","Orta","Yorgun","Bitkin"],s:[1,2,3,4,5]},
          {q:"Ne sÄ±klÄ±kla dÃ¼ÅŸÃ¼ncelere dalÄ±yorsunuz?",a:["HiÃ§bir zaman","Nadiren","Bazen","SÄ±k sÄ±k","SÃ¼rekli"],s:[1,2,3,4,5]},
          {q:"Dikkat daÄŸÄ±lmadan odaklanabilme durumunuz:",a:["Ã‡ok iyi","Ä°yi","Orta","Zor","Ä°mkansÄ±z"],s:[1,2,3,4,5]},
          {q:"Ruh haliniz dengeli mi?",a:["Ã‡ok","OldukÃ§a","KÄ±smen","Pek deÄŸil","HiÃ§ deÄŸil"],s:[1,2,3,4,5]},
          {q:"Mevcut stres seviyeniz nedir?",a:["Ã‡ok dÃ¼ÅŸÃ¼k","DÃ¼ÅŸÃ¼k","Orta","YÃ¼ksek","Ã‡ok yÃ¼ksek"],s:[1,2,3,4,5]}
        ]
      },
      fr: {
        ui: {
          start:"Commencer", iq:"Test de QI", psy:"PsychÃ©", stats:"Statistiques",
          introHint:"Vos rÃ©sultats sont stockÃ©s uniquement dans votre navigateur.",
          live:{ title:"Status en Direct", ready:"PrÃªt.", activeIQ:"Test de QI", activePsy:"Test PsychÃ©" },
          labels:{ lastIQ:"Dernier Score QI:", lastPsy:"Dernier Niveau PsychÃ©:", history:"Historique" },
          results:{
            iq:(s,t)=>`Votre score QI: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=12?"TrÃ¨s dÃ©tendu": tot<=20?"Tension lÃ©gÃ¨re":"Stress Ã©levÃ©"
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? "Excellent! Logique et motifs maÃ®trisÃ©s." : s/t>=0.5 ? "Bonne base. AmÃ©liorez vitesse et prÃ©cision." : "Retour aux fondamentaux: calcul mental et motifs.",
            psy:(lvl)=> lvl.includes("Ã©levÃ©") ? "Essayez 5min de respiration + marche." : lvl.includes("lÃ©gÃ¨re") ? "45min de concentration, puis micro-pause." : "Stable â€“ gardez vos routines."
          },
          compare:{ better:(c)=>`Au-dessus de la moyenne vs ${c}.`, avg:(c)=>`Dans la moyenne de ${c}.`, worse:(c)=>`En dessous de la moyenne vs ${c}.` }
        },
        iq: [
          {q:"Combien fait 9 Ã— 9?",a:["72","81","99"],c:1},
          {q:"Que vaut 5Â³?",a:["25","125","225"],c:1},
          {q:"Quel nombre suit: 2,4,8,16,?",a:["24","32","36"],c:1},
          {q:"Choisissez l\\'opposÃ© de \"chaotique\"",a:["ordonnÃ©","agitÃ©","nerveux"],c:0},
          {q:"Combien vaut 20% de 400?",a:["40","60","80"],c:2},
          {q:"ComplÃ©tez: 3,6,9,12,?",a:["13","14","15"],c:2},
          {q:"Combien fait 12 Ã— 12?",a:["124","144","132"],c:1},
          {q:"Racine carrÃ©e de 81?",a:["7","8","9"],c:2},
          {q:"Combien de secondes dans une heure?",a:["3600","6000","1800"],c:0},
          {q:"Si 4 stylos coÃ»tent 3â‚¬, combien pour 12 stylos?",a:["6â‚¬","9â‚¬","12â‚¬"],c:1},
          {q:'Si un rectangle mesure 5 cm de large et 8 cm de long, quelle est sa surface?',a:['40','13','20'],c:0,cat:'math'},
          {q:'Quel nombre complÃ¨te la sÃ©rie: 4,9,16,25,?',a:['30','36','49'],c:1,cat:'pattern'},
          {q:'Si une journÃ©e a 24 heures, combien de minutes fait une demi-journÃ©e?',a:['720','600','480'],c:0,cat:'math'},
          {q:'Quel mot n\'appartient pas: professeur, Ã©lÃ¨ve, stylo, tableau?',a:['stylo','Ã©lÃ¨ve','tableau'],c:0,cat:'verbal'},
          {q:'Souvenez-vous des chiffres: 3,7,2. Quel chiffre Ã©tait au milieu?',a:['3','7','2'],c:1,cat:'memory'},
          {q:'Continuez: 2,3,5,7,11,?',a:['12','13','15'],c:1,cat:'logic'}
        ],
        psy: [
          {q:"Ã€ quelle frÃ©quence vous sentez-vous sous pression?",a:["Jamais","Rarement","Parfois","Souvent","TrÃ¨s souvent"],s:[1,2,3,4,5]},
          {q:"Arrivez-vous Ã  dÃ©connecter facilement?",a:["Oui","La plupart du temps","Parfois","Rarement","Non"],s:[1,2,3,4,5]},
          {q:"Comment gÃ©rez-vous les conflits?",a:["TrÃ¨s stable","Stable","Incertain","Instable","TrÃ¨s instable"],s:[1,2,3,4,5]},
          {q:"Comment vous sentez-vous le matin?",a:["TrÃ¨s reposÃ©","Bien","Moyen","FatiguÃ©","Ã‰puisÃ©"],s:[1,2,3,4,5]},
          {q:"Ã€ quelle frÃ©quence ruminez-vous?",a:["Jamais","Rarement","Parfois","Souvent","Constamment"],s:[1,2,3,4,5]},
          {q:"Votre concentration sans distraction?",a:["Excellente","Bonne","Moyenne","Difficile","Impossible"],s:[1,2,3,4,5]},
          {q:"Votre humeur est-elle Ã©quilibrÃ©e?",a:["TrÃ¨s","Assez","Parfois","Pas vraiment","Pas du tout"],s:[1,2,3,4,5]},
          {q:"Quel est votre niveau de stress actuel?",a:["TrÃ¨s bas","Bas","Moyen","Ã‰levÃ©","TrÃ¨s Ã©levÃ©"],s:[1,2,3,4,5]}
        ]
      },
      en: {
        ui: {
          start:'Start', iq:'IQ Test', psy:'Psyche', stats:'Stats',
          introHint:'Your results are stored locally in your browser only.',
          live:{ title:'Live Status', ready:'Ready.', activeIQ:'IQ Test', activePsy:'Psyche' },
          labels:{ lastIQ:'Last IQ Score:', lastPsy:'Last Psyche Level:', history:'History' },
          results:{
            iq:(s,t)=>`Your IQ score: ${s} / ${t}`,
            psycheLevel:(tot)=> tot<=12?'Very relaxed': tot<=20?'Mild tension':'Elevated stress'
          },
          ai:{
            iq:(s,t)=> s/t>=0.8 ? 'Great! Strong logic & patterns.' : s/t>=0.5 ? 'Solid base. Improve speed & accuracy.' : 'Back to fundamentals: mental math & patterns.',
            psy:(lvl)=> lvl.includes('Elevated') ? 'Try 5â€‘minute breathing + short walk.' : lvl.includes('Mild') ? '45â€‘min focus, then a microâ€‘break.' : 'Stable â€“ keep routines.'
          },
          compare:{ better:(c)=>`Above average vs ${c}.`, avg:(c)=>`Around the average of ${c}.`, worse:(c)=>`Below average vs ${c}.` }
        },
        iq: [
          {q:'What is 9 Ã— 9?',a:['72','81','99'],c:1},
          {q:'What is 5Â³?',a:['25','125','225'],c:1},
          {q:'Which number comes next: 2,4,8,16,?',a:['24','32','36'],c:1},
          {q:'Choose the opposite of â€œchaoticâ€',a:['orderly','hectic','nervous'],c:0},
          {q:'What is 20% of 400?',a:['40','60','80'],c:2},
          {q:'Complete: 3,6,9,12,?',a:['13','14','15'],c:2},
          {q:'What is 12 Ã— 12?',a:['124','144','132'],c:1},
          {q:'Square root of 81?',a:['7','8','9'],c:2},
          {q:'How many seconds in an hour?',a:['3600','6000','1800'],c:0},
          {q:'If all roses are flowers and some flowers wither quickly, what follows?',a:['All roses wither quickly','Some roses wither quickly','No roses wither'],c:1},
          {q:'If 4 pens cost $3, how much for 12 pens?',a:['$6','$9','$12'],c:1},
          {q:'Which word does not belong: apple, banana, carrot, orange?',a:['carrot','banana','orange'],c:0},
          {q:'What is 15 Ã— 15?',a:['215','225','235'],c:1},
          {q:'Complete the sequence: 1,4,9,16,?',a:['20','25','36'],c:1},
          {q:'7 Ã— 8 + 3 = ?',a:['53','56','59'],c:2},
          {q:'What is the square root of 169?',a:['12','13','14'],c:1},
          {q:'Which shape has four equal sides and opposite angles equal?',a:['Square','Rectangle','Parallelogram'],c:0}
        ],
        psy: [
          {q:'How often do you feel under pressure?',a:['Never','Rarely','Sometimes','Often','Very often'],s:[1,2,3,4,5]},
          {q:'Can you switch off well?',a:['Yes','Mostly','Partly','Rarely','No'],s:[1,2,3,4,5]},
          {q:'How stable are you in conflicts?',a:['Very stable','Stable','Insecure','Unstable','Very unstable'],s:[1,2,3,4,5]},
          {q:'How refreshed do you feel in the morning?',a:['Very','Good','Soâ€‘so','Tired','Exhausted'],s:[1,2,3,4,5]},
          {q:'How often do you ruminate?',a:['Never','Rarely','Sometimes','Often','Constantly'],s:[1,2,3,4,5]},
          {q:'How well can you focus without distraction?',a:['Very well','Well','Okay','Hard','Not at all'],s:[1,2,3,4,5]},
          {q:'How balanced is your mood?',a:['Very','Quite','Partly','Rather not','Not at all'],s:[1,2,3,4,5]},
          {q:'What is your current stress level?',a:['Very low','Low','Medium','High','Very high'],s:[1,2,3,4,5]},
          {q:'How well do you manage interruptions?',a:['Very well','Well','Okay','Poor','Very poor'],s:[1,2,3,4,5]},
          {q:'How regular is your sleep schedule?',a:['Very regular','Mostly','Sometimes','Rarely','Never'],s:[1,2,3,4,5]},
          {q:'How often do you exercise per week?',a:['Daily','Several times','Once','Rarely','Never'],s:[1,2,3,4,5]},
          {q:'How motivated do you feel for daily tasks?',a:['Very motivated','Motivated','Neutral','Less motivated','Unmotivated'],s:[1,2,3,4,5]}
        ]
      }
    };

    // Language flag mapping for leaderboard and UI
    const langFlags = { de: 'ğŸ‡©ğŸ‡ª', en: 'ğŸ‡¬ğŸ‡§', fr: 'ğŸ‡«ğŸ‡·', es: 'ğŸ‡ªğŸ‡¸', tr: 'ğŸ‡¹ğŸ‡·' };

    // =====================
    // Sprache speichern/laden
    // =====================
    const langSelect = document.getElementById('langSelect');
    const getLang = () => localStorage.getItem('lang') || 'de'; // Deutsch als Standard
    const setLang = (l)=>{ 
      localStorage.setItem('lang', l); 
      langSelect.value = l; 
      document.documentElement.lang = l; // HTML lang attribute aktualisieren
      applyLang(); 
    };

    // Helpers to safely get localized content (fallback to 'en')
    function getLocale(key) {
      return (i18n[getLang()] && i18n[getLang()].ui && i18n[getLang()].ui[key]) ? i18n[getLang()].ui[key] : i18n['en'].ui[key];
    }
    function getIQ(){ return (i18n[getLang()] && i18n[getLang()].iq) ? i18n[getLang()].iq : i18n['en'].iq; }
    function getPsy(){ return (i18n[getLang()] && i18n[getLang()].psy) ? i18n[getLang()].psy : i18n['en'].psy; }

    // =====================
    // Screen Handling / Navigation
    // =====================
    const screens = document.querySelectorAll('.screen');
    const navButtons = document.querySelectorAll('.tab-buttons button');
    const liveTestEl = document.getElementById('liveTest');
    const liveQuestionEl = document.getElementById('liveQuestion');
    const liveScoreEl = document.getElementById('liveScore');
    const liveNoteEl = document.getElementById('liveNote');

    function showScreen(id){
      screens.forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      liveTestEl.textContent = id === 'iqTest' ? (getLang()==='de'? i18n.de.ui.live.activeIQ : i18n.en.ui.live.activeIQ)
        : id === 'psyTest' ? (getLang()==='de'? i18n.de.ui.live.activePsy : i18n.en.ui.live.activePsy)
        : 'â€“';
      liveNoteEl.textContent = id === 'psyTest' ? (getLang()==='de'?'Ehrlich antworten.':'Answer honestly.') : (getLang()==='de'? i18n.de.ui.live.ready : i18n.en.ui.live.ready);
      if(id === 'stats') updateStatsDisplay();
    }

    navButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target = btn.getAttribute('data-screen');
        showScreen(target);
      });
    });

    // =====================
    // Consent Banner
    // =====================
    const consentBanner = document.getElementById('consentBanner');
    const consentOk = document.getElementById('consentOk');
    if(localStorage.getItem('consentAccepted') === '1') consentBanner.style.display = 'none';
    consentOk.addEventListener('click',()=>{ localStorage.setItem('consentAccepted','1'); consentBanner.style.display = 'none'; });

    // =====================
    // IQâ€‘Test Logik + KIâ€‘Feedback + LÃ¤nder-Vergleich
    // =====================
    const iqContainer = document.getElementById('iqQuestions');
    const iqResult = document.getElementById('iqResult');
    const aiTip = document.getElementById('aiTip');
  
  // current selected category (null = all)
  let currentCategory = null;
  // currentQuestionSet keeps the shuffled question order for the ongoing test
  let currentQuestionSet = null;
  let iqIndex = 0; let iqScore = 0;
  // track user's chosen answers for breakdown
  let iqUserAnswers = [];

  // (use safer getIQ above)

    // Return an array of categories for IQ questions. If questions define a `cat` property use it,
    // otherwise assign a repeating pattern by index.
    function getIQCategories(rawArr){
      const pattern = ['math','pattern','logic','verbal','memory'];
      return rawArr.map((q,i)=> q.cat ? q.cat : pattern[i % pattern.length]);
    }

    // Fisher-Yates shuffle (in-place)
    function shuffleArray(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function renderIQ(selectedCategory) {
      const raw = getIQ();
      var arr; // will hold the ordered question set for this run
      // if we already have a currentQuestionSet for this category, reuse it
      if(currentQuestionSet && currentQuestionSet._category === selectedCategory){
        arr = currentQuestionSet.slice();
      } else {
        // attach category metadata to each question
        const categories = getIQCategories(raw);
        const arrWithMeta = raw.map((q,i)=> Object.assign({}, q, { __cat: categories[i] }));
        arr = arrWithMeta;
        // if a category is requested, filter the questions
        if(selectedCategory) arr = arrWithMeta.filter((q)=> q.__cat === selectedCategory);
        // shuffle the question order to avoid repeating the same starting questions
        shuffleArray(arr);
        // persist the set for the duration of this test
        currentQuestionSet = arr.slice();
        currentQuestionSet._category = selectedCategory || null;
      }
      if(iqIndex >= arr.length) {
        const msg = i18n[getLang()].ui.results.iq(iqScore, arr.length);
        iqResult.textContent = msg;

        // KIâ€‘Feedback (lokal, regelbasiert)
        const tip = i18n[getLang()].ui.ai.iq(iqScore, arr.length);
        aiTip.textContent = 'ğŸ¤– ' + tip;

        // Weltweite Einordnung (Percentile) + LÃ¤ndervergleich (Deutschland â‰ˆ 102)
        const percentile = Math.round((iqScore / arr.length) * 100);
        let globalRank = 'â€”';
        if(percentile >= 90) globalRank = getLang()==='de' ? 'Top 10% weltweit' : 'Top 10% worldwide';
        else if(percentile >= 70) globalRank = getLang()==='de' ? 'Top 30% weltweit' : 'Top 30% worldwide';
        else if(percentile >= 50) globalRank = getLang()==='de' ? 'Durchschnittsbereich weltweit' : 'Average range worldwide';
        else if(percentile >= 30) globalRank = getLang()==='de' ? 'Unterdurchschnittlich (global)' : 'Below average (global)';
        else globalRank = getLang()==='de' ? 'Deutlich unter Durchschnitt (global)' : 'Significantly below average (global)';

        const country = getLang()==='de' ? 'Deutschland (Ã˜ 102)' : 'World avg (100)';
        const estIQ = Math.round((iqScore / arr.length) * 150); // grobe Normierung auf 150 Max
        let compareTxt;
        if(getLang()==='de'){
          compareTxt = estIQ > 107 ? i18n.de.ui.compare.better(country) : estIQ < 97 ? i18n.de.ui.compare.worse(country) : i18n.de.ui.compare.avg(country);
        } else {
          compareTxt = estIQ > 105 ? i18n.en.ui.compare.better(country) : estIQ < 95 ? i18n.en.ui.compare.worse(country) : i18n.en.ui.compare.avg(country);
        }

        const globalInfo = document.createElement('div');
        globalInfo.style.color = 'var(--accent2)';
        globalInfo.style.marginTop = '0.6rem';
        globalInfo.style.fontWeight = '600';
        globalInfo.style.textAlign = 'center';
        globalInfo.innerHTML = `ğŸŒ <strong>${getLang()==='de' ? 'Weltweite Einstufung' : 'Global Ranking'}:</strong> ${globalRank}<br>ğŸ§  ${compareTxt}`;
        iqResult.insertAdjacentElement('afterend', globalInfo);

        // build details array showing each question, chosen answer and correctness
        const details = arr.map((q, idx) => ({
          q: q.q,
          choices: q.a,
          chosenIndex: typeof iqUserAnswers[idx] === 'number' ? iqUserAnswers[idx] : null,
          correctIndex: q.c,
          correct: typeof iqUserAnswers[idx] === 'number' ? (iqUserAnswers[idx] === q.c) : false,
          category: q.__cat || 'general'
        }));

        // compute per-category scores
        const categoryScores = {};
        details.forEach(d=>{
          const cat = d.category || 'general';
          if(!categoryScores[cat]) categoryScores[cat] = { correct:0, total:0 };
          if(d.chosenIndex !== null) {
            categoryScores[cat].total += 1;
            if(d.correct) categoryScores[cat].correct += 1;
          }
        });

  saveResult({ type:'iq', score: iqScore, total: arr.length, ts: Date.now(), lang:getLang(), details, categories: categoryScores });
        // also render a detailed breakdown below the result
        const breakdown = document.createElement('div');
        breakdown.style.marginTop = '1rem';
        breakdown.innerHTML = '<h4 style="color:var(--accent);margin-bottom:.4rem">Detailierte Auswertung</h4>' +
          details.map((d,i)=>{
            const chosen = d.chosenIndex!==null ? d.choices[d.chosenIndex] : 'â€”';
            const correct = d.choices[d.correctIndex];
            const ok = d.correct ? 'âœ…' : 'âŒ';
            return `<div style="text-align:left;padding:.4rem;border-radius:8px;margin-bottom:.25rem;background:rgba(255,255,255,0.02)"><strong>Frage ${i+1}:</strong> ${d.q}<br><em>Deine Antwort:</em> ${chosen} ${ok} <br><em>Richtig:</em> ${correct}</div>`;
          }).join('');
        iqResult.insertAdjacentElement('afterend', breakdown);
        // reset user answers for next run
        iqUserAnswers = [];
        updateStatsDisplay();
        // Show psycho/help suggestions based on IQ result
        try{ showHelpForResult('iq', { estIQ, percentile, score: iqScore, total: arr.length }); }catch(e){ console.warn('showHelpForResult failed', e); }
        return;
      }

      const q = arr[iqIndex];
      liveQuestionEl.textContent = iqIndex+1; liveScoreEl.textContent = iqScore;
      iqContainer.innerHTML = `
        <div class="question">
          <h3>${q.q}</h3>
          ${q.a.map((opt,i)=>`<button class="option" data-i="${i}">${opt}</button>`).join('')}
        </div>
      `;

      iqContainer.querySelectorAll('button.option').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const chosen = Number(btn.getAttribute('data-i'));
          // store chosen answer for this question
          iqUserAnswers[iqIndex] = chosen;
          if(chosen === q.c) {
            iqScore++;
            correctSound.play().catch(e => console.log('Sound play failed:', e));
            btn.style.background = 'linear-gradient(90deg,#00ff00,#00cc00)';
          } else {
            incorrectSound.play().catch(e => console.log('Sound play failed:', e));
            btn.style.background = 'linear-gradient(90deg,#ff0000,#cc0000)';
          }
          
          // Disable all buttons after answer
          btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
          
          // Show correct answer if wrong
          if(chosen !== q.c) {
            btn.parentElement.querySelectorAll('button')[q.c].style.background = 'linear-gradient(90deg,#00ff00,#00cc00)';
          }
          
          // Wait a moment to show the result
          setTimeout(() => {
            iqIndex++;
            renderIQ(currentCategory);
          }, 1000);
        });
      });
    }

    // =====================
    // Psycheâ€‘Analyse Logik (5â€‘Stufen) + KIâ€‘Tipp
    // =====================
    const psyContainer = document.getElementById('psyQuestions');
    const psyResult = document.getElementById('psyResult');
    let psyAnswers = [];

  // (use safer getPsy above)

    function renderPsy(){
      psyContainer.innerHTML = '';
      psyAnswers = [];
      const arr = getPsy();

      arr.forEach((item, idx) => {
        const block = document.createElement('div');
        block.classList.add('question');
        block.innerHTML = `
          <h3>${item.q}</h3>
          ${item.a.map((ans,i)=>`<button class="option" data-question="${idx}" data-score="${item.s[i]}">${ans}</button>`).join('')}
        `;
        psyContainer.appendChild(block);
      });

      psyContainer.querySelectorAll('button.option').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const qIndex = Number(btn.getAttribute('data-question'));
          const score  = Number(btn.getAttribute('data-score'));
            // store chosen index and score for details
            const chosenIndex = Array.from(btn.parentElement.querySelectorAll('button.option')).indexOf(btn);
            if(!psyAnswers[qIndex]) psyAnswers[qIndex] = {};
            psyAnswers[qIndex] = { chosenIndex, score, label: btn.textContent };

          if(psyAnswers.filter(v=>v!==undefined).length === getPsy().length){
              const total = psyAnswers.reduce((a,b)=>a + (b.score||0),0);
              const lvl = i18n[getLang()].ui.results.psycheLevel(total);
              psyResult.textContent = lvl;
              const tip = i18n[getLang()].ui.ai.psy(lvl);
              aiTip.textContent = 'ğŸ¤– ' + tip;
              // build details for psyche
              const psyDetails = getPsy().map((item, idx) => ({ q: item.q, chosen: psyAnswers[idx] ? psyAnswers[idx].label : null, score: psyAnswers[idx] ? psyAnswers[idx].score : null }));
              saveResult({ type:'psy', level: lvl, score: total, ts: Date.now(), lang:getLang(), details: psyDetails });
              updateStatsDisplay();
              try{ showHelpForResult('psy', { score: total, level: lvl }); }catch(e){ console.warn('showHelpForResult failed', e); }
          }
        });
      });
    }

    // =====================
    // Storage Persistenz & Statistik (mit IndexedDB Fallback)
    // =====================
    const statLastIQ = document.getElementById('statLastIQ');
    const statPsyLevel = document.getElementById('statPsyLevel');
    const historyList = document.getElementById('historyList');
    const clearDataBtn = document.getElementById('clearDataBtn');

    async function saveResult(entry){
      try {
        // Try IndexedDB first
        await saveResultToDB(entry);
      } catch (e) {
        // Fallback to localStorage
        saveResultToLocalStorage(entry);
      }
      // Update stats immediately after saving
      try{ updateStatsDisplay(); }catch(e){ /* ignore if UI not ready yet */ }
    }

    async function getHistoryData() {
      try {
        // Try IndexedDB first
        const dbData = await getHistoryFromDB();
        if (dbData && dbData.length > 0) return dbData;
      } catch (e) {
        console.log('IndexedDB read failed, using localStorage');
      }
      // Fallback to localStorage
      const raw = localStorage.getItem('history');
      return raw ? JSON.parse(raw) : [];
    }

    // Chart Instances
    let progressChart = null;
    let stressChart = null;

    function updateStatsDisplay(){
      getHistoryData().then(hist => {
        if (!Array.isArray(hist)) hist = [];
        
        // Update Charts
        updateCharts(hist);
        
        // Berechne durchschnittliche IQ-Performance
        const iqTests = hist.filter(e => e.type === 'iq');
        const avgScore = iqTests.length > 0 
          ? Math.round(iqTests.reduce((acc, curr) => acc + (curr.score / curr.total * 100), 0) / iqTests.length) 
          : 0;
        document.getElementById('avgIQScore').textContent = avgScore + '%';
        document.getElementById('totalIQTests').textContent = `${iqTests.length} Tests absolviert`;
        
        // Berechne aktuelles Stress-Level
        const psyTests = hist.filter(e => e.type === 'psy');
        const latestPsy = psyTests[psyTests.length - 1];
        document.getElementById('currentStressLevel').textContent = latestPsy ? latestPsy.level : '--';
        document.getElementById('totalPsyTests').textContent = `${psyTests.length} Tests absolviert`;
        // Berechne Kategorie-Durchschnitte (falls in history vorhanden)
        const categoryEl = document.getElementById('categoryBreakdown');
        if(categoryEl){
          // aggregate over all IQ entries that include categories
          const catAgg = {};
          hist.filter(e=>e.type==='iq' && e.categories).forEach(e=>{
            Object.entries(e.categories).forEach(([cat,vals])=>{
              if(!catAgg[cat]) catAgg[cat] = { correct:0, total:0, count:0 };
              catAgg[cat].correct += vals.correct || 0;
              catAgg[cat].total += vals.total || 0;
              if(vals.total && vals.total>0) catAgg[cat].count += 1;
            });
          });

          if(Object.keys(catAgg).length===0){
            categoryEl.textContent = 'Noch keine Kategoriescores vorhanden.';
          } else {
            // build display lines
            const lines = Object.keys(catAgg).map(cat=>{
              const v = catAgg[cat];
              const pct = v.total>0 ? Math.round((v.correct / v.total) * 100) : 0;
              return `${cat}: ${pct}% (${v.correct}/${v.total})`;
            });
            categoryEl.innerHTML = lines.join('<br>');
          }
        }
        
        // Berechne Performance-Trend
        if (iqTests.length >= 2) {
          const recent = iqTests.slice(-3); // Letzte 3 Tests
          const trend = recent.reduce((acc, curr, i, arr) => {
            if (i === 0) return 0;
            return acc + (curr.score/curr.total - arr[i-1].score/arr[i-1].total);
          }, 0);
          
          const trendEl = document.getElementById('performanceTrend');
          if (trend > 0) {
            trendEl.textContent = 'ğŸ“ˆ Verbesserung';
            trendEl.style.color = '#00ff00';
          } else if (trend < 0) {
            trendEl.textContent = 'ğŸ“‰ Leichter RÃ¼ckgang';
            trendEl.style.color = 'var(--danger)';
          } else {
            trendEl.textContent = 'â¡ï¸ Stabil';
            trendEl.style.color = 'var(--accent)';
          }
        }

        const lastIQ = [...hist].reverse().find(e=>e.type==='iq');
        statLastIQ.textContent = lastIQ ? `${lastIQ.score} / ${lastIQ.total}` : 'â€“';

        const lastPsy = [...hist].reverse().find(e=>e.type==='psy');
        statPsyLevel.textContent = lastPsy ? lastPsy.level : 'â€“';

        // Filter-Handler fÃ¼r Verlauf
        const filterButtons = document.querySelectorAll('.history-filter button');
        filterButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const filter = btn.getAttribute('data-filter');
            updateHistory(hist, filter);
            
            // Update Button-Styles
            filterButtons.forEach(b => {
              b.style.background = b === btn ? 
                'linear-gradient(90deg,var(--accent),var(--accent2))' : 
                'linear-gradient(90deg,var(--accent2),var(--accent))';
            });
          });
        });
        
        updateHistory(hist, 'week'); // Standard: Diese Woche anzeigen
      });
    }
    
    // =====================
    // Help / Psycho suggestions (videos, breathing exercise, transcripts)
    // =====================
    function showHelpForResult(type, info){
      // type: 'iq' or 'psy'
      const container = document.getElementById(type === 'iq' ? 'iqHelp' : 'psyHelp');
      const content = document.getElementById(type === 'iq' ? 'iqHelpContent' : 'psyHelpContent');
      const transcript = document.getElementById(type === 'iq' ? 'iqTranscript' : 'psyTranscript');
      if(!container || !content) return;
      container.style.display = 'block';
      transcript.style.display = 'none';
      // default guidance blocks
      if(type === 'iq'){
        const est = info.estIQ || 100;
        const pct = info.percentile || Math.round((info.score/info.total)*100);
        if(est < 97 || pct < 40){
          content.innerHTML = `
            <strong>Entspanne & fokussiere dich</strong>
            <p>Dein Ergebnis deutet auf Verbesserungs-Potenzial hin. Ein kurzes Atemtraining kann helfen, Stress zu verringern und die Konzentration zu steigern.</p>
            <div class="breath-circle" id="breathCircle"></div>
            <div class="breath-controls">
              <button class="small" id="startBreathBtn">Start AtemÃ¼bung</button>
              <button class="small" id="stopBreathBtn">Stopp</button>
              <button class="small" id="showVideoBtn">Video ansehen (optional)</button>
            </div>
            <p style="font-size:.9rem;color:var(--muted);margin-top:.6rem">Du kannst eigene Videos in den Ordner <code>store-assets/help</code> legen und sie hier verlinken.</p>
          `;
        } else if(est < 110){
          content.innerHTML = `<strong>Gute Leistung â€” wenig Feinschliff nÃ¶tig</strong><p>Kurze KonzentrationsÃ¼bungen (5â€“10 Minuten) helfen, das Niveau zu halten.</p><div style="margin-top:.6rem"><button class="small" id="showVideoBtn">KonzentrationsÃ¼bung ansehen</button></div>`;
        } else {
          content.innerHTML = `<strong>Sehr gut!</strong><p>Deine Leistung ist Ã¼berdurchschnittlich. Zur weiteren Verbesserung zeigen wir fortgeschrittene Denkaufgaben und Fokustraining.</p><div style="margin-top:.6rem"><button class="small" id="showVideoBtn">Fortgeschrittene Ãœbung</button></div>`;
        }
      } else {
        // psyche suggestions (info.level may be descriptive)
        const lvl = info.level || ''; const score = info.score || 0;
        if(score >= 15 || /hoch|hoch/.test(String(lvl).toLowerCase())){
          content.innerHTML = `
            <strong>Entlastung empfohlen</strong>
            <p>Deine Antworten deuten auf erhÃ¶hten Stress hin. Versuche eine angeleitete AtemÃ¼bung oder ein kurzes Video zur Entspannung.</p>
            <div class="breath-circle" id="breathCircle"></div>
            <div class="breath-controls">
              <button class="small" id="startBreathBtn">Start AtemÃ¼bung</button>
              <button class="small" id="stopBreathBtn">Stopp</button>
              <button class="small" id="showVideoBtn">Video ansehen (optional)</button>
            </div>
          `;
        } else if(score >= 8){
          content.innerHTML = `<strong>Leichte Belastung</strong><p>Kurze Pausen und AtemÃ¼bungen kÃ¶nnen helfen, das Wohlbefinden zu stabilisieren.</p><div style="margin-top:.6rem"><button class="small" id="startBreathBtn">AtemÃ¼bung starten</button></div>`;
        } else {
          content.innerHTML = `<strong>Geringe Belastung</strong><p>Alles sieht gut aus. Weiterhin auf gute Pausen und Schlaf achten.</p>`;
        }
      }

      // wire controls (breathing + video)
      const startBtn = container.querySelector('#startBreathBtn');
      const stopBtn = container.querySelector('#stopBreathBtn');
      const showVideoBtn = container.querySelector('#showVideoBtn');
      startBtn?.addEventListener('click', startBreathing);
      stopBtn?.addEventListener('click', stopBreathing);
      showVideoBtn?.addEventListener('click', () => {
        // respect user consent for external embeds
        const consent = localStorage.getItem('consentVideoEmbed') === '1';
        if(!consent){
          if(confirm('Video von externen Diensten laden? (YouTube) â€“ Zustimmung speichern?')){
            localStorage.setItem('consentVideoEmbed','1');
          } else {
            // show offline transcript fallback
            transcript.style.display = 'block';
            transcript.textContent = 'Kein Online-Zugriff erlaubt. Du kannst eigene Videos in store-assets/help ablegen und hier verlinken.';
            return;
          }
        }
        // load a sample YouTube privacy-enhanced embed (user may change id)
        const videoId = type === 'iq' ? 'JwYX52BP2Sk' : 'z6X5oEIg6Ak';
        content.innerHTML += `<div style="margin-top:0.8rem"><iframe width="100%" height="240" src="https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="Hilfs-Video"></iframe></div>`;
      });
    }

    // Breathing animation control
    let breathInterval = null;
    let breathSettings = {
      inhale: parseInt(localStorage.getItem('breathInhale') || '4'),
      hold: parseInt(localStorage.getItem('breathHold') || '4'),
      exhale: parseInt(localStorage.getItem('breathExhale') || '4'),
      holdAfter: parseInt(localStorage.getItem('breathHoldAfter') || '0')
    };

    function startBreathing(){
      const circle = document.getElementById('breathCircle');
      if(!circle) return;
      let phase = 0; // 0 inhale, 1 hold, 2 exhale, 3 hold
      const timings = [
        breathSettings.inhale * 1000,
        breathSettings.hold * 1000,
        breathSettings.exhale * 1000,
        breathSettings.holdAfter * 1000
      ];
      circle.style.transform = 'scale(1)';
      breathInterval = setInterval(()=>{
        if(phase === 0){ circle.style.transform = 'scale(1.25)'; circle.title = `Einatmen (${breathSettings.inhale}s)`; }
        else if(phase === 1){ circle.style.transform = 'scale(1.25)'; circle.title = `Halten (${breathSettings.hold}s)`; }
        else if(phase === 2){ circle.style.transform = 'scale(0.85)'; circle.title = `Ausatmen (${breathSettings.exhale}s)`; }
        else { circle.style.transform = 'scale(0.85)'; circle.title = `Halten (${breathSettings.holdAfter}s)`; }
        phase = (phase + 1) % 4;
      }, Math.min(...timings.filter(t => t > 0)) || 4000);
    }
    function stopBreathing(){ if(breathInterval){ clearInterval(breathInterval); breathInterval=null; const circle = document.getElementById('breathCircle'); if(circle) circle.style.transform='scale(1)'; } }

    function updateHistory(hist, filter) {
      const now = new Date();
      const filtered = hist.filter(entry => {
        const entryDate = new Date(entry.ts);
        if (filter === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return entryDate >= weekAgo;
        } else if (filter === 'month') {
          const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
          return entryDate >= monthAgo;
        }
        return true; // 'all' Filter
      });
      
      historyList.innerHTML = '';
      if (filtered.length === 0) {
        historyList.innerHTML = '<li style="text-align:center;color:var(--muted)">Keine EintrÃ¤ge im gewÃ¤hlten Zeitraum</li>';
        return;
      }
      
      filtered.slice().reverse().forEach(entry=>{
        let line='';
        if(entry.type==='iq') line = `IQ: ${entry.score}/${entry.total}`;
        else if(entry.type==='psy') line = `Psyche: ${entry.level} (Score ${entry.score})`;
        const li = document.createElement('li');
        const date = new Date(entry.ts).toLocaleString();
        // main text
        const mainSpan = document.createElement('span');
        mainSpan.textContent = `${date} â€“ ${line}`;
        li.appendChild(mainSpan);

        // details toggle if available
        if(entry.details && Array.isArray(entry.details) && entry.details.length){
          const detailsBtn = document.createElement('button');
          detailsBtn.className = 'small';
          detailsBtn.style.marginLeft = '0.6rem';
          detailsBtn.textContent = 'Details';
          const detailsDiv = document.createElement('div');
          detailsDiv.style.display = 'none';
          detailsDiv.style.marginTop = '0.5rem';
          detailsDiv.style.textAlign = 'left';
          // build html for details depending on type
          if(entry.type === 'iq'){
            detailsDiv.innerHTML = entry.details.map((d,i)=>{
              const chosen = (d.chosenIndex!==null && d.choices[d.chosenIndex]) ? d.choices[d.chosenIndex] : 'â€”';
              const correct = d.choices[d.correctIndex];
              const ok = d.correct ? 'âœ…' : 'âŒ';
              return `<div style="padding:.3rem;border-radius:6px;margin-bottom:.2rem;background:rgba(255,255,255,0.02)"><strong>Q${i+1}:</strong> ${d.q}<br><em>Deine:</em> ${chosen} ${ok} <em>Richtig:</em> ${correct}</div>`;
            }).join('');
          } else if(entry.type === 'psy'){
            detailsDiv.innerHTML = entry.details.map((d,i)=>{
              return `<div style="padding:.3rem;border-radius:6px;margin-bottom:.2rem;background:rgba(255,255,255,0.02)"><strong>Q${i+1}:</strong> ${d.q}<br><em>Antwort:</em> ${d.chosen} <em>(Score ${d.score})</em></div>`;
            }).join('');
          }

          detailsBtn.addEventListener('click', ()=>{
            detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
            detailsBtn.textContent = detailsDiv.style.display === 'none' ? 'Details' : 'SchlieÃŸen';
          });
          li.appendChild(detailsBtn);
          li.appendChild(detailsDiv);
        }

        historyList.appendChild(li);
      });

      // Highscore IQ
      const highscoreIQ = document.getElementById('highscoreIQ');
      if (highscoreIQ) {
        highscoreIQ.innerHTML = '';
  const iqScores = hist.filter(e=>e.type==='iq').map(e=>({score:e.score,total:e.total,date:e.ts, lang: e.lang || 'de'}));
  // Sort by score desc, then by most recent date
  iqScores.sort((a,b)=> (b.score - a.score) || (b.date - a.date));
        iqScores.slice(0,5).forEach(e=>{
          const li = document.createElement('li');
          const flag = langFlags[e.lang] || 'ğŸ³ï¸';
          li.innerHTML = `<span style="margin-right:.4rem">${flag}</span> <strong>${e.score} / ${e.total}</strong> <span style="color:var(--muted); margin-left:.6rem">(${new Date(e.date).toLocaleDateString()})</span>`;
          highscoreIQ.appendChild(li);
        });
        if(iqScores.length===0){
          const li = document.createElement('li');
          li.textContent = 'â€“';
          highscoreIQ.appendChild(li);
        }
      }

      // Highscore Psyche
      const highscorePsy = document.getElementById('highscorePsy');
      if (highscorePsy) {
        highscorePsy.innerHTML = '';
  const psyScores = hist.filter(e=>e.type==='psy').map(e=>({score:e.score,level:e.level,date:e.ts, lang: e.lang || 'de'}));
  // For psyche, lower score means better (more relaxed) â€” show best (lowest) first, tiebreak by most recent
  psyScores.sort((a,b)=> (a.score - b.score) || (b.date - a.date));
        psyScores.slice(0,5).forEach(e=>{
          const li = document.createElement('li');
          const flag = langFlags[e.lang] || 'ğŸ³ï¸';
          li.innerHTML = `<span style="margin-right:.4rem">${flag}</span> <strong>${e.level}</strong> <span style="color:var(--muted); margin-left:.6rem">(${e.score})</span> <span style="color:var(--muted); margin-left:.6rem">(${new Date(e.date).toLocaleDateString()})</span>`;
          highscorePsy.appendChild(li);
        });
        if(psyScores.length===0){
          const li = document.createElement('li');
          li.textContent = 'â€“';
          highscorePsy.appendChild(li);
        }
      }
    }

    function updateCharts(hist) {
      const ctx1 = document.getElementById('progressChart');
      const ctx2 = document.getElementById('stressChart');

      // Process data for IQ progress
      const iqData = hist.filter(e => e.type === 'iq').map(e => ({
        score: (e.score / e.total) * 100,
        date: new Date(e.ts)
      }));

      // Process data for Stress levels
      const stressData = hist.filter(e => e.type === 'psy').map(e => ({
        score: e.score,
        date: new Date(e.ts)
      }));

  // Destroy existing charts
  if (progressChart) progressChart.destroy();
  if (stressChart) stressChart.destroy();

      // Create IQ Progress Chart
      progressChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: iqData.map(d => d.date.toLocaleDateString()),
          datasets: [{
            label: 'IQ Score (%)',
            data: iqData.map(d => d.score),
            borderColor: '#00ffd1',
            backgroundColor: 'rgba(0, 255, 209, 0.08)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#f0f0f0' }
            },
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#f0f0f0' }
            }
          },
          plugins: { legend: { labels: { color: '#f0f0f0' } } }
        }
      });

      // Create Stress Level Chart
      stressChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: stressData.map(d => d.date.toLocaleDateString()),
          datasets: [{
            label: 'Stress Level',
            data: stressData.map(d => d.score),
            borderColor: '#00b8a5',
            backgroundColor: 'rgba(0, 184, 165, 0.08)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#f0f0f0' } },
            x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#f0f0f0' } }
          },
          plugins: { legend: { labels: { color: '#f0f0f0' } } }
        }
      });
    }

    clearDataBtn.addEventListener('click',()=>{
      localStorage.removeItem('history');
      updateStatsDisplay();
    });

    // Demo / Seed data for testing the leaderboard
    const seedDemoBtn = document.getElementById('seedDemoBtn');
    if(seedDemoBtn){
      seedDemoBtn.addEventListener('click', ()=>{
        const sample = [
          {type:'iq', score:18, total:20, ts: Date.now()-86400000*2, lang:'de'},
          {type:'iq', score:15, total:20, ts: Date.now()-86400000*5, lang:'de'},
          {type:'iq', score:20, total:20, ts: Date.now()-86400000*1, lang:'de'},
          {type:'psy', level:'Sehr entspannt', score:16, ts: Date.now()-86400000*3, lang:'de'},
          {type:'psy', level:'Leichte Anspannung', score:30, ts: Date.now()-86400000*6, lang:'de'},
          {type:'psy', level:'Sehr entspannt', score:18, ts: Date.now()-86400000*1, lang:'de'}
        ];
        localStorage.setItem('history', JSON.stringify(sample));
        updateStatsDisplay();
      });
    }

    // =====================
    // Category Selection
    // =====================
    document.querySelectorAll('.category-select button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentCategory = btn.getAttribute('data-category');
        // reset any existing question set so we build a fresh shuffled set for this category
        currentQuestionSet = null;
        iqIndex = 0;
        iqScore = 0;
        iqUserAnswers = [];
        renderIQ(currentCategory);
        
        // Highlight selected category
        document.querySelectorAll('.category-select button').forEach(b => {
          b.style.background = b === btn ? 
            'linear-gradient(90deg,var(--accent),var(--accent2))' : 
            'linear-gradient(90deg,var(--accent2),var(--accent))';
        });
      });
    });

    // =====================
    // Start Button Verhalten
    // =====================
    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('click',()=>{
      showScreen('iqTest');
  // start fresh question set (shuffle) when starting a new test
  currentQuestionSet = null;
  iqIndex = 0; iqScore = 0; renderIQ(currentCategory);
      startBtn.disabled = true;
      startBtn.textContent = getLang()==='de' ? 'LÃ¤uft...' : 'Running...';
    });

    // =====================
    // Sprache anwenden (sichere Fallbacks)
    // =====================
    function applyLang(){
      // Use the selected language UI object if available, otherwise fall back to English
      const L = (i18n[getLang()] && i18n[getLang()].ui) ? i18n[getLang()].ui : i18n['en'].ui;
      document.getElementById('tabStart').textContent = L.start;
      document.getElementById('tabIQ').textContent = L.iq;
      document.getElementById('tabPsy').textContent = L.psy;
      document.getElementById('tabStats').textContent = L.stats;
      document.getElementById('hintLocal').textContent = L.introHint;
      // Some nested properties may not exist in all translations; guard access
      document.getElementById('liveStatusTitle').textContent = (L.live && L.live.title) ? L.live.title : i18n['en'].ui.live.title;
      document.getElementById('iqTitle').textContent = L.iq;
      document.getElementById('psyTitle').textContent = L.psy;
      document.getElementById('statsTitle').textContent = L.stats;
      document.getElementById('labelLastIQ').textContent = (L.labels && L.labels.lastIQ) ? L.labels.lastIQ : i18n['en'].ui.labels.lastIQ;
      document.getElementById('labelLastPsy').textContent = (L.labels && L.labels.lastPsy) ? L.labels.lastPsy : i18n['en'].ui.labels.lastPsy;
      document.getElementById('historyH3').textContent = (L.labels && L.labels.history) ? L.labels.history : i18n['en'].ui.labels.history;
      // Re-render any language-dependent screens
      try{ renderPsy(); } catch(e){ console.warn('renderPsy() failed during language apply:', e); }
    }

    langSelect.addEventListener('change', ()=> setLang(langSelect.value));

    // Automatische Statistik-Aktualisierung
    function startStatsAutoUpdate() {
      // Initial update
      updateStatsDisplay();
      
      // Update alle 30 Sekunden, wenn Statistik-Tab aktiv ist
      setInterval(() => {
        if (document.getElementById('stats').classList.contains('active')) {
          updateStatsDisplay();
        }
      }, 30000);
    }

    // Initialisieren
    setLang(getLang());
    renderPsy();
    
    // Initialize IndexedDB and migrate data if needed
    initIndexedDB().then(() => {
      migrateToIndexedDB().catch(e => console.log('IndexedDB init/migration skipped:', e));
    }).catch(e => {
      console.log('IndexedDB not available, using localStorage:', e);
    });

    // Start auto-updating stats
    try{ 
      startStatsAutoUpdate();
    } catch(e){ 
      console.log('Fehler beim Initialisieren der Statistik:', e);
    }

    // --- Anpassbares Zitat (lokal editierbar) ---
    (function(){
      const quoteEl = document.querySelector('.quote');
      if(!quoteEl) return;
      // Lade gespeichertes Zitat (falls vorhanden)
      const saved = localStorage.getItem('customQuote');
      if(saved) quoteEl.textContent = saved;

      // Erstelle Bearbeiten-Button
      const editBtn = document.createElement('button');
      editBtn.className = 'small';
      editBtn.style.marginLeft = '0.6rem';
      editBtn.style.background = 'linear-gradient(90deg,var(--accent2),var(--accent))';
      editBtn.textContent = 'Zitat bearbeiten';
      editBtn.title = 'Zitat anpassen (nur lokal)';
      editBtn.addEventListener('click', ()=>{
        const current = quoteEl.textContent || '';
        const v = prompt('Neues Zitat eingeben (Autor optional):', current);
        if(v !== null){
          quoteEl.textContent = v;
          localStorage.setItem('customQuote', v);
          // kleine Animation zurÃ¼cksetzen
          quoteEl.style.animation = 'none';
          void quoteEl.offsetWidth;
          quoteEl.style.animation = 'quoteReveal 2s ease-out';
        }
      });

      // FÃ¼ge Button unter dem Zitat hinzu
      quoteEl.insertAdjacentElement('afterend', editBtn);
    })();

    // =====================
    // Theme Management
    // =====================
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    
    // Get/Set Theme
    // Prefer an explicit user choice saved in localStorage; otherwise follow the OS preference
    const getTheme = () => {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      try {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) return 'light';
      } catch (e) { /* ignore */ }
      // default to light for a clear, readable UI
      return 'light';
    };

    const setTheme = (theme, persist = true) => {
      if (persist) localStorage.setItem('theme', theme);
      document.documentElement.dataset.theme = theme;
      themeIcon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
    };

    // Theme Toggle Handler
    themeToggle.addEventListener('click', () => {
      const newTheme = getTheme() === 'dark' ? 'light' : 'dark';
      setTheme(newTheme, true);
    });

    // React to OS theme changes, but only when user hasn't explicitly chosen
    try {
      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: light)');
        mq.addEventListener?.('change', e => {
          if (!localStorage.getItem('theme')) {
            setTheme(e.matches ? 'light' : 'dark', false);
          }
        });
      }
    } catch (e) { /* ignore for older browsers */ }

    // Initialize Theme
    setTheme(getTheme(), true);

    // =====================
    // Tutorial System
    // =====================
    const tutorial = document.getElementById('tutorial');
    const tutorialSteps = document.querySelectorAll('.tutorial-step');
    const tutorialNext = document.getElementById('tutorialNext');
    const tutorialPrev = document.getElementById('tutorialPrev');
    let currentStep = 1;

    // Show Tutorial for First-time Users
    if (!localStorage.getItem('tutorialSeen')) {
      tutorial.classList.add('active');
      updateTutorialButtons();
    }

    function updateTutorialButtons() {
      tutorialPrev.style.display = currentStep === 1 ? 'none' : 'block';
      tutorialNext.textContent = currentStep === tutorialSteps.length ? 'Fertig' : 'Weiter';
      
      tutorialSteps.forEach((step, i) => {
        step.classList.toggle('active', i + 1 === currentStep);
      });
    }

    tutorialNext.addEventListener('click', () => {
      if (currentStep < tutorialSteps.length) {
        currentStep++;
        updateTutorialButtons();
      } else {
        tutorial.classList.remove('active');
        localStorage.setItem('tutorialSeen', '1');
      }
    });

    tutorialPrev.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        updateTutorialButtons();
      }
    });

    // =====================
    // Achievement System
    // =====================
    const achievements = {
      firstTest: { icon: 'ğŸ¯', title: 'Erster Test', desc: 'Du hast deinen ersten Test abgeschlossen!' },
      perfectScore: { icon: 'ğŸ†', title: 'Perfekte Punktzahl', desc: 'Alle Fragen richtig beantwortet!' },
      speedMaster: { icon: 'âš¡', title: 'Geschwindigkeitsmeister', desc: 'Test in Rekordzeit abgeschlossen!' },
      dailyStreak: { icon: 'ğŸ”¥', title: 'TÃ¤gliche Serie', desc: 'Du trainierst regelmÃ¤ÃŸig!' },
      brainMaster: { icon: 'ğŸ§ ', title: 'Gehirn-Meister', desc: 'Hohe Punktzahl in allen Kategorien!' }
    };

    function showAchievement(id) {
      const achievement = achievements[id];
      if (!achievement) return;

      const popup = document.createElement('div');
      popup.className = 'achievement-popup';
      popup.innerHTML = `
        <div class="achievement-icon">${achievement.icon}</div>
        <div class="achievement-info">
          <h4 class="achievement-title">${achievement.title}</h4>
          <p class="achievement-desc">${achievement.desc}</p>
        </div>
      `;

      document.body.appendChild(popup);
      setTimeout(() => popup.classList.add('show'), 100);
      setTimeout(() => {
        popup.classList.remove('show');
        setTimeout(() => popup.remove(), 300);
      }, 3000);

      // Save achievement
      const earned = JSON.parse(localStorage.getItem('achievements') || '[]');
      if (!earned.includes(id)) {
        earned.push(id);
        localStorage.setItem('achievements', JSON.stringify(earned));
      }
    }

    // Service Worker Registration (relative path for project pages)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // register service worker with explicit repo-scoped path so it works on GitHub Pages site at /Iq-trainer-/
        navigator.serviceWorker.register('/Iq-trainer-/sw.js', { scope: '/Iq-trainer-/' })
          .then(registration => {
            console.log('ServiceWorker registration successful');
            
            // Setup push notifications if supported
            if ('Notification' in window) {
              Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                  setupDailyReminder();
                }
              });
            }
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    // Daily reminder setup
    function setupDailyReminder() {
      const now = new Date();
      const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 9, 0, 0); // 9:00 AM tomorrow
      const delay = tomorrow - now;

      setTimeout(() => {
        new Notification('Zeit fÃ¼rs Training! ğŸ§ ', {
          body: 'Dein tÃ¤gliches IQ-Training wartet auf dich.',
          icon: 'icons/icon-152x152.png'
        });
        setupDailyReminder(); // Schedule next reminder
      }, delay);
    }

    // Check achievements after tests
    function checkAchievements(type, score, total) {
      const history = JSON.parse(localStorage.getItem('history') || '[]');
      
      // First test achievement
      if (history.length === 1) {
        showAchievement('firstTest');
      }

      // Perfect score
      if (score === total) {
        showAchievement('perfectScore');
      }

      // Daily streak (if applicable)
      const streak = parseInt(localStorage.getItem('daily_streak') || '0');
      if (streak >= 3) {
        showAchievement('dailyStreak');
      }
    }

    // =====================
    // Settings Management
    // =====================
    const breathInhaleInput = document.getElementById('breathInhale');
    const breathHoldInput = document.getElementById('breathHold');
    const breathExhaleInput = document.getElementById('breathExhale');
    const breathHoldAfterInput = document.getElementById('breathHoldAfter');

    // Initialize breath settings from localStorage
    function initBreathSettings() {
      breathInhaleInput.value = breathSettings.inhale;
      breathHoldInput.value = breathSettings.hold;
      breathExhaleInput.value = breathSettings.exhale;
      breathHoldAfterInput.value = breathSettings.holdAfter;
      updateBreathDisplay();
    }

    function updateBreathDisplay() {
      document.getElementById('breathInhaleValue').textContent = breathInhaleInput.value;
      document.getElementById('breathHoldValue').textContent = breathHoldInput.value;
      document.getElementById('breathExhaleValue').textContent = breathExhaleInput.value;
      document.getElementById('breathHoldAfterValue').textContent = breathHoldAfterInput.value;
      
      breathSettings.inhale = parseInt(breathInhaleInput.value);
      breathSettings.hold = parseInt(breathHoldInput.value);
      breathSettings.exhale = parseInt(breathExhaleInput.value);
      breathSettings.holdAfter = parseInt(breathHoldAfterInput.value);
      
      localStorage.setItem('breathInhale', breathSettings.inhale);
      localStorage.setItem('breathHold', breathSettings.hold);
      localStorage.setItem('breathExhale', breathSettings.exhale);
      localStorage.setItem('breathHoldAfter', breathSettings.holdAfter);
    }

    // Event listeners for breath settings
    [breathInhaleInput, breathHoldInput, breathExhaleInput, breathHoldAfterInput].forEach(input => {
      input.addEventListener('change', updateBreathDisplay);
      input.addEventListener('input', updateBreathDisplay);
    });

    document.getElementById('breathTestBtn')?.addEventListener('click', () => {
      stopBreathing();
      setTimeout(() => startBreathing(), 200);
      const popup = document.createElement('div');
      popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card-bg);border:2px solid var(--accent);padding:2rem;border-radius:16px;z-index:10000;text-align:center;color:var(--text)';
      popup.innerHTML = `
        <p style="margin-top:0">AtemÃ¼bung lÃ¤uft...</p>
        <button class="option small" onclick="stopBreathing();this.parentElement.remove()">Stopp</button>
      `;
      document.body.appendChild(popup);
      setTimeout(() => {
        if (popup.parentElement) {
          stopBreathing();
          popup.remove();
        }
      }, (breathSettings.inhale + breathSettings.hold + breathSettings.exhale + breathSettings.holdAfter) * 1000 * 3);
    });

    document.getElementById('breathResetBtn')?.addEventListener('click', () => {
      breathSettings = { inhale: 4, hold: 4, exhale: 4, holdAfter: 0 };
      localStorage.setItem('breathInhale', '4');
      localStorage.setItem('breathHold', '4');
      localStorage.setItem('breathExhale', '4');
      localStorage.setItem('breathHoldAfter', '0');
      initBreathSettings();
    });

    // Notification settings
    const notifEnabled = document.getElementById('notifEnabled');
    const notifTime = document.getElementById('notifTime');

    if (notifEnabled) {
      notifEnabled.checked = localStorage.getItem('notifEnabled') === '1';
      notifTime.value = localStorage.getItem('notifTime') || '09:00';

      notifEnabled.addEventListener('change', () => {
        localStorage.setItem('notifEnabled', notifEnabled.checked ? '1' : '0');
        if (notifEnabled.checked && 'Notification' in window) {
          Notification.requestPermission();
        }
      });

      notifTime.addEventListener('change', () => {
        localStorage.setItem('notifTime', notifTime.value);
      });
    }

    // Export data function
    function exportUserData() {
      getHistoryData().then(hist => {
        const data = {
          version: '2.0.0',
          exportDate: new Date().toISOString(),
          lang: getLang(),
          theme: localStorage.getItem('theme'),
          breathSettings,
          history: hist
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `iq-trainer-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    // Import data function
    function importUserData(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.history && Array.isArray(data.history)) {
            localStorage.setItem('history', JSON.stringify(data.history));
            alert('Daten erfolgreich importiert!');
            updateStatsDisplay();
          } else {
            alert('UngÃ¼ltige Dateiformat.');
          }
        } catch (err) {
          alert('Fehler beim Lesen der Datei: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('exportDataBtn')?.addEventListener('click', exportUserData);
    document.getElementById('importDataBtn')?.addEventListener('click', () => {
      document.getElementById('importFile').click();
    });
    document.getElementById('importFile')?.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        importUserData(e.target.files[0]);
      }
    });

    // Initialize settings UI
    initBreathSettings();
    
    // Update storage info
    const storageInfo = document.getElementById('storageInfo');
    if (storageInfo && 'storage' in navigator && 'estimate' in navigator.storage) {
      navigator.storage.estimate().then(({ usage, quota }) => {
        const usedMB = (usage / 1024 / 1024).toFixed(2);
        const quotaMB = (quota / 1024 / 1024).toFixed(2);
        storageInfo.textContent = `${usedMB} MB / ${quotaMB} MB genutzt`;
      });
    }

    // Keyboard Navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.show');
        modals.forEach(modal => modal.classList.remove('show'));
      }
    });

    // Accessibility Improvements
    document.querySelectorAll('button').forEach(button => {
      if (!button.getAttribute('aria-label')) {
        button.setAttribute('aria-label', button.textContent.trim());
      }
    });

    // Focus Management
    function trapFocus(element) {
      const focusableElements = element.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusableElement = focusableElements[0];
      const lastFocusableElement = focusableElements[focusableElements.length - 1];

      element.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstFocusableElement) {
              lastFocusableElement.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastFocusableElement) {
              firstFocusableElement.focus();
              e.preventDefault();
            }
          }
        }
      });
    }

    // Apply focus trap to modals
    document.querySelectorAll('.modal').forEach(trapFocus);
  </script>
</body>
</html>




